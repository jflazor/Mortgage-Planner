<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Mortgage Planner | Simple Calculator & Payoff Tool</title>
    <meta name="description" content="A simple, ad-free mortgage calculator. Plan payoff strategies, calculate PMI removal, and share scenarios instantly without signing up.">
    
    <link rel="canonical" href="https://mortgageplanner.net" />

    <link rel="icon" href="https://mortgageplanner.net/favicon.png?v=17" type="image/png" sizes="any">
    <link rel="apple-touch-icon" sizes="180x180" href="https://mortgageplanner.net/favicon.png?v=17">
    <link rel="icon" sizes="192x192" href="https://mortgageplanner.net/favicon.png?v=17">

    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIk1vcnRnYWdlIFBsYW5uZXIiLAogICJzaG9ydF9uYW1lIjogIk1vcnRnYWdlIiwKICAic3RhcnRfdXJsIjogImh0dHBzOi8vbW9ydGdhZ2VwbGFubmVyLm5ldCIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiMwZjE3MmEiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL21vcnRnYWdlcGxhbm5lci5uZXQvZmF2aWNvbi5wbmciLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9tb3J0Z2FnZXBsYW5uZXIubmV0L2Zhdmljb24ucG5nIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXQp9">

    <meta property="og:site_name" content="Mortgage Planner">
    <meta property="og:title" content="Mortgage Planner | Simple Mortgage Calculator">
    <meta property="og:description" content="I built a custom mortgage plan. Click to see the exact numbers, payoff date, and total savings.">
    <meta property="og:url" content="https://mortgageplanner.net">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://mortgageplanner.net/og-image.png?v=17">
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Mortgage Payoff Planner",
      "applicationCategory": "FinanceApplication",
      "operatingSystem": "Web",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "description": "A simple, shareable mortgage calculator that allows users to create and send custom payoff scenarios via link.",
      "featureList": "Amortization schedule, Shareable scenario links, PMI removal date, Tax increase projection",
      "author": {
        "@type": "Organization",
        "name": "Mortgage Planner",
        "url": "https://mortgageplanner.net"
      }
    }
    </script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-HPMLZPDC1Z"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      // Iframe-Optimized Config
      gtag('config', 'G-HPMLZPDC1Z', {
          'cookie_flags': 'SameSite=None;Secure', 
          'page_location': window.location.href,
          'page_referrer': document.referrer
      });
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        /* 1. RESET & VARIABLES */
        :root {
            --brand-navy: #0f172a;
            --brand-navy-light: #1e293b;
            --brand-teal: #0d9488;
            --brand-teal-dark: #0f766e;
            --brand-slate: #64748b;
            --brand-purple: #8b5cf6;
            --brand-red: #ef4444;
            --brand-green-bg: #ecfdf5;
            --brand-green-border: #6ee7b7;
            --brand-green-text: #065f46;
            
            --bg-body: #f1f5f9;
            --bg-white: #ffffff;
            --border-color: #cbd5e1;
        }

        /* GLOBAL BOX SIZING FIX */
        *, *::before, *::after { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }
        
        html, body {
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden; 
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--brand-navy);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            line-height: 1.5;
            padding-top: 72px; 
        }

        /* EMBED MODE STYLES */
        body.embed-mode {
            padding-top: 0;
            background-color: transparent;
        }
        body.embed-mode nav, 
        body.embed-mode .hero, 
        body.embed-mode footer, 
        body.embed-mode .embed-cta, /* Hide the embed CTA inside the embed itself */
        body.embed-mode .content-section, 
        body.embed-mode .coffee-section {
            display: none !important;
        }
        body.embed-mode .app-container {
            margin-top: 1rem;
            margin-bottom: 1rem;
            padding: 0 1rem; /* Reduce padding slightly in embed */
        }
        
        /* FIX: FORCE BREAKDOWNS TO BE SPACIOUS IN EMBED MODE */
        /* Override 3-col summary cards to be 1-col in embed unless really wide */
        body.embed-mode .summary-cards {
            grid-template-columns: 1fr !important; 
        }
        @media (min-width: 700px) {
            body.embed-mode .summary-cards {
                grid-template-columns: 1fr 1fr 1fr !important;
            }
        }

        /* Override 4-col lifetime totals to be 2-col in embed unless really wide */
        body.embed-mode .lifetime-grid {
            grid-template-columns: 1fr 1fr 1fr 1fr !important;
        }
        @media (min-width: 900px) {
            body.embed-mode .lifetime-grid {
                grid-template-columns: 1fr 1fr 1fr 1fr !important;
            }
        }

        /* New Footer for Embed Mode Only */
        .embed-footer {
            display: none;
            text-align: center;
            font-size: 0.8rem;
            color: var(--brand-slate);
            margin-top: 1rem;
            padding-bottom: 1rem;
        }
        .embed-footer a {
            color: var(--brand-teal);
            text-decoration: none;
            font-weight: 600;
        }
        body.embed-mode .embed-footer {
            display: block;
        }

        /* 2. NAVIGATION */
        nav {
            background: var(--brand-navy);
            padding: 1rem 0;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            position: fixed; 
            top: 0;
            left: 0;
            z-index: 1000;
            width: 100%;
        }

        .nav-container {
            width: 100%; 
            padding: 0 2rem; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo { font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 10px; white-space: nowrap; }
        .logo svg { width: 22px; height: 22px; color: var(--brand-teal); flex-shrink: 0; }
        
        .nav-links a { text-decoration: none; color: #94a3b8; font-size: 0.9rem; font-weight: 500; transition: color 0.2s; cursor: pointer; white-space: nowrap; }
        .nav-links a:hover { color: white; }

        /* 3. HERO (UPDATED FOR SIMPLICITY) */
        .hero { background: white; padding: 2.5rem 1.5rem; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; text-align: center; width: 100%; }
        .hero h1 { font-size: 2rem; font-weight: 800; color: var(--brand-navy); margin-bottom: 0.5rem; letter-spacing: -0.02em; }
        .hero p { color: var(--brand-slate); font-size: 1.1rem; max-width: 600px; margin: 0 auto 1.5rem auto; line-height: 1.6; }
        
        /* HERO BADGES */
        .hero-badges {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 1.5rem;
            margin-top: 1rem;
        }
        .badge-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--brand-slate);
            font-weight: 500;
        }
        .badge-item svg {
            width: 16px;
            height: 16px;
            color: var(--brand-teal);
        }

        /* 4. LAYOUT */
        .app-container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            flex: 1; 
            margin-bottom: 2rem; /* Reduced from 3rem to sit closer to embed link */
            width: 100%;
            max-width: 100vw;
        }

        @media(min-width: 850px) {
            .app-container { grid-template-columns: 380px 1fr; }
        }

        /* --- MOBILE OPTIMIZATIONS --- */
        @media (max-width: 600px) {
            body { padding-top: 60px; }
            
            nav { padding: 0.75rem 0; }
            .nav-container { padding: 0 1rem; } 
            
            .hero { padding: 1.5rem 1rem; }
            .hero h1 { font-size: 1.6rem; }
            .hero p { font-size: 1rem; margin-bottom: 1rem; }
            .hero-badges { gap: 1rem; }
            
            .app-container { padding: 0 12px; gap: 1.5rem; }
            
            .split-inputs { grid-template-columns: 1fr; gap: 0.75rem; }
            .three-col-mobile-fix { grid-template-columns: 1fr 1fr 1fr !important; gap: 0.25rem !important; }

            .summary-cards { 
                grid-template-columns: 1fr !important; 
                gap: 1rem !important; 
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .results-header button { width: 100%; }
            .results-actions { width: 100%; }
        }

        /* CARD STYLES */
        .card {
            background: var(--bg-white);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            height: fit-content;
            width: 100%;
            max-width: 100%;
            overflow: hidden; 
        }

        @media (max-width: 600px) {
            .card { padding: 1.25rem; }
        }

        .card h2 {
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--brand-slate);
            margin-bottom: 1.5rem;
            font-weight: 700;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 10px;
        }

        /* --- INPUT STYLING --- */
        .input-group { margin-bottom: 1.25rem; width: 100%; }
        
        /* UPDATED LABEL STYLING: Force Height Alignment & Prevent Wrap */
        .input-group > label, 
        .input-group > .label-row {
            display: flex;
            align-items: center;
            height: 34px; 
            margin-bottom: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--brand-navy);
            gap: 6px;
        }

        /* Apply white-space: nowrap to prevent text wrapping */
        label {
            white-space: nowrap; 
        }

        /* Reset for the label inside the row so it doesn't double height */
        .label-row label {
            margin-bottom: 0;
            height: auto; 
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            white-space: nowrap; 
        }

        /* Helper for the Label Row with Select */
        .label-row {
            justify-content: space-between;
            width: 100%;
        }

        .input-wrapper { position: relative; display: flex; align-items: center; width: 100%; }

        .input-icon {
            position: absolute;
            left: 12px;
            color: var(--brand-slate);
            font-weight: 500;
            font-size: 0.9rem;
            pointer-events: none; 
        }
        .input-icon.right { left: auto; right: 12px; }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            color: var(--brand-navy);
            transition: all 0.2s;
            background: #f8fafc;
            box-sizing: border-box;
        }

        input.has-left-icon { padding-left: 28px; }
        input.has-right-icon { padding-right: 28px; }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--brand-navy);
            background: white;
            box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.1);
        }

        /* NEW HELPER TEXT CLASS */
        .helper-text {
            font-size: 0.75rem;
            color: var(--brand-teal);
            font-weight: 600;
            margin-top: 4px;
            min-height: 1.2em; 
        }

        .input-row { display: flex; gap: 10px; width: 100%; }
        .split-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; width: 100%; }

        /* TOOLTIPS */
        .tooltip-icon { cursor: help; color: var(--brand-slate); width: 14px; height: 14px; }
        .tooltip-container { position: relative; display: flex; align-items: center; }
        
        /* UPDATED TOOLTIP CSS FOR WRAPPING */
        .tooltip-text {
            visibility: hidden; 
            width: 220px; /* Slightly wider */
            background-color: var(--brand-navy); 
            color: #fff; 
            text-align: center;
            border-radius: 6px; 
            padding: 8px; 
            position: absolute; 
            z-index: 10; 
            bottom: 125%; 
            left: 50%;
            margin-left: -110px; /* Center alignment based on new width */
            opacity: 0; 
            transition: opacity 0.3s; 
            font-size: 0.75rem; 
            font-weight: 400;
            line-height: 1.4; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            white-space: normal; /* CRITICAL FIX: Allows text to wrap */
        }
        
        /* NEW FIX: Specifically for tooltips near the right edge (like HOA) */
        .tooltip-text.shift-left {
            left: auto;
            right: -10px;       /* Anchors right side of tooltip near the icon */
            margin-left: 0;     /* Removes the centering margin */
            transform: none; 
        }
        
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

        /* ADVANCED SECTION */
        .advanced-link { color: var(--brand-teal); font-size: 0.9rem; font-weight: 600; cursor: pointer; display: inline-block; margin-bottom: 0.5rem; user-select: none; }
        .advanced-link:hover { text-decoration: underline; color: var(--brand-teal-dark); }
        .advanced-content { margin-top: 0.5rem; padding-top: 1rem; border-top: 1px dashed var(--border-color); background: #f8fafc; padding: 1rem; border-radius: 6px; }
        .advanced-sub-header { font-size: 0.9rem; font-weight: 700; color: var(--brand-navy); margin-bottom: 0.75rem; margin-top: 0.5rem; }

        /* ONE TIME PAYMENT ROWS */
        .otp-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; width: 100%; }
        .otp-remove-btn { background: none; border: none; color: var(--brand-red); cursor: pointer; font-size: 1.1rem; padding: 0 5px; line-height: 1; }
        .otp-remove-btn:hover { opacity: 0.7; }
        .otp-add-btn { background: none; border: none; color: var(--brand-teal); font-size: 0.85rem; font-weight: 600; cursor: pointer; padding: 0; display: flex; align-items: center; gap: 4px; }
        .otp-add-btn:hover { text-decoration: underline; }

        /* BUTTONS - STANDARDIZED */
        .btn-primary { 
            width: 100%; 
            padding: 0.75rem 1.5rem; /* Standardized Padding */
            background-color: var(--brand-navy); 
            color: white; 
            border: 1px solid transparent; /* Match border width of cancel button */
            border-radius: 6px; 
            font-weight: 600; 
            font-size: 1rem; 
            cursor: pointer; 
            transition: background 0.2s; 
            margin-top: 0; /* Remove default margin */
        }
        .btn-primary:hover { background-color: var(--brand-navy-light); }
        
        /* Specific override for the main Calculate button to add spacing */
        #calcBtn {
            margin-top: 1rem;
        }

        .btn-secondary { background: transparent; border: 1px solid var(--brand-navy); color: var(--brand-navy); padding: 0.5rem 1rem; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 0.85rem; }
        .btn-secondary:hover { background: #f1f5f9; }
        
        /* NEW EXAMPLE BUTTON STYLES (MOBILE OPTIMIZED) */
        .example-row {
            display: flex;
            flex-direction: column; /* Default: Stack vertically (Mobile) */
            gap: 8px;
            margin-bottom: 1.25rem;
            padding-bottom: 1.25rem;
            border-bottom: 1px dashed #e2e8f0;
        }
        .example-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        
        .btn-example-small { 
            width: 100%; /* Full width on mobile */
            background: white; 
            border: 1px solid #e2e8f0; 
            border-left: 4px solid var(--brand-teal); 
            color: var(--brand-navy); 
            padding: 0.75rem 1rem; /* Slightly larger tap target */
            border-radius: 4px; 
            font-weight: 600; 
            cursor: pointer; 
            font-size: 0.85rem;
            text-align: left; 
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .btn-example-small:hover { 
            border-color: #cbd5e1;
            background-color: #f8fafc;
            padding-left: 1.2rem; 
        }
        
        .example-desc { font-size: 0.85rem; color: #475569; line-height: 1.4; padding-left: 4px; }

        /* Desktop Layout Overrides for Examples */
        @media (min-width: 600px) {
            .example-row {
                flex-direction: row; /* Side by side on Desktop */
                align-items: center;
                gap: 15px;
                margin-bottom: 1rem;
                padding-bottom: 1rem;
            }
            .btn-example-small {
                width: auto; /* Natural width */
                min-width: 160px;
                flex-shrink: 0;
                padding: 0.6rem 1rem;
            }
            .example-desc { padding-left: 0; }
        }

        /* EMBED CTA SECTION (New) */
        .embed-cta {
            text-align: center;
            margin-bottom: 3rem;
            padding: 0 1.5rem;
        }
        .embed-cta a {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--brand-slate);
            font-size: 0.9rem;
            font-weight: 500;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            background-color: #fff;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
            cursor: pointer;
        }
        .embed-cta a:hover {
            color: var(--brand-navy);
            border-color: var(--brand-teal);
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .embed-cta svg {
            width: 16px;
            height: 16px;
            color: var(--brand-teal);
        }

        /* COFFEE BUTTON */
        .coffee-section { text-align: center; margin-bottom: 3rem; padding: 0 1rem; }
        .coffee-section p { font-size: 0.9rem; color: var(--brand-slate); margin-bottom: 0.75rem; font-weight: 500; }
        .btn-coffee { 
            display: inline-flex; align-items: center; gap: 8px;
            background-color: white; border: 1px solid var(--border-color); color: var(--brand-navy); 
            padding: 0.75rem 1.5rem; border-radius: 50px; font-weight: 600; text-decoration: none; 
            font-size: 0.9rem; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .btn-coffee:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-color: var(--brand-teal); color: var(--brand-teal-dark); }

        /* RESULTS UI */
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); }
        .results-header h2 { border: none; padding: 0; margin: 0; }
        
        /* SCROLL MARGIN FIX */
        #results { scroll-margin-top: 120px; }
        
        .results-actions { display: flex; gap: 10px; }

        .summary-cards { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 1rem; 
            margin-bottom: 2rem; 
            background: #f8fafc; 
            padding: 1rem; 
            border-radius: 8px; 
            border: 1px solid #e2e8f0; 
            width: 100%;
            box-sizing: border-box; 
        }

        @media (max-width: 600px) {
            .summary-cards { 
                grid-template-columns: 1fr !important; 
                gap: 1rem !important; 
            }
            .mini-card {
                display: flex;
                justify-content: space-between;
                align-items: center;
                text-align: left !important;
                padding: 0.5rem 0;
                border-bottom: 1px solid #e2e8f0;
            }
            .mini-card:last-child { border-bottom: none; }
            .mini-card small { margin-bottom: 0 !important; font-size: 0.8rem; }
            .mini-card strong { font-size: 1rem; }
        }
        
        .mini-card { text-align: center; background: transparent; }
        .mini-card small { display: block; color: var(--brand-slate); font-size: 0.75rem; margin-bottom: 4px; font-weight: 600; text-transform: uppercase; }
        .mini-card strong { display: block; color: var(--brand-navy); font-size: 1.1rem; font-weight: 700; }
        .mini-card .highlight { color: var(--brand-teal); font-size: 1.25rem; }

        /* SAVINGS IMPACT CARD - UPDATED FOR DESKTOP SLIM */
        .savings-card {
            background: var(--brand-green-bg);
            border: 1px solid var(--brand-green-border);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            text-align: center;
            display: none; /* Hidden by default */
            animation: pulse-card 0.4s ease-out;
        }
        .savings-card.visible { display: block; }
        
        .savings-header { color: var(--brand-green-text); font-weight: 700; font-size: 1.1rem; margin-bottom: 0.75rem; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .savings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem; }
        .savings-item small { display: block; font-size: 0.75rem; color: #047857; text-transform: uppercase; font-weight: 600; margin-bottom: 4px; }
        .savings-item strong { display: block; font-size: 1.2rem; color: var(--brand-green-text); font-weight: 800; }
        
        /* DESKTOP OPTIMIZATION FOR SAVINGS CARD (Slim Bar) */
        @media (min-width: 850px) {
            .savings-card.visible {
                display: flex; /* Turn into Flex Row */
                align-items: center;
                justify-content: center;
                gap: 3rem;
                text-align: left;
                padding: 1rem 1.5rem;
            }
            .savings-header {
                margin-bottom: 0;
                font-size: 1rem;
            }
            .savings-grid {
                margin-top: 0;
                display: flex;
                gap: 3rem;
                padding: 0 2rem;
                border-left: 1px solid var(--brand-green-border);
            }
            .savings-item { text-align: left; }
        }
        
        .chart-container { 
            position: relative; 
            height: 260px; 
            margin-bottom: 2rem; 
            width: 100%; 
            max-width: 100%; 
            overflow: hidden; 
        }

        /* NEW LIFETIME TOTALS BREAKDOWN */
        .lifetime-totals {
            margin-bottom: 2rem;
            background: #fff;
            border-top: 1px dashed var(--border-color);
            padding-top: 1.5rem;
        }
        .lifetime-header {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--brand-navy);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .lifetime-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2 columns on mobile */
            gap: 1rem;
        }
        
        /* 4 Columns on Desktop (Wide screens only) */
        @media (min-width: 900px) {
            .lifetime-grid {
                grid-template-columns: 1fr 1fr 1fr 1fr;
            }
        }
        
        .lifetime-item {
            display: flex;
            flex-direction: column;
        }
        .lifetime-label {
            font-size: 0.75rem;
            color: var(--brand-slate);
            font-weight: 600;
            margin-bottom: 2px;
        }
        .lifetime-value {
            font-size: 1rem;
            font-weight: 700;
            color: var(--brand-navy);
        }
        
        /* UPDATED LIFETIME TOTAL ROW FOR MOBILE & DESKTOP */
        .lifetime-total-row {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: space-between; /* Default Mobile: Push items to edges */
            gap: 10px; /* Smaller gap to prevent wrapping */
        }
        
        /* Desktop: Bring them closer together */
        @media (min-width: 600px) {
            .lifetime-total-row {
                justify-content: flex-start; /* Left align */
                gap: 2rem; /* Reasonable gap */
            }
        }
        
        /* New class to replace inline styles for better mobile control */
        .lifetime-total-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #64748b;
            white-space: nowrap; /* Forces text to stay on one line */
        }

        .lifetime-total-val {
            font-size: 1.25rem;
            color: var(--brand-teal-dark);
            font-weight: 800;
            white-space: nowrap; /* Forces text to stay on one line */
        }

        /* Mobile specific shrink to fit large millions */
        @media (max-width: 400px) {
            .lifetime-total-label { font-size: 0.75rem; }
            .lifetime-total-val { font-size: 1rem; }
        }

        /* ACCORDION TABLE */
        .table-wrapper {
            max-height: 500px;
            overflow-y: auto;
            overflow-x: auto; 
            border: 1px solid var(--border-color);
            border-radius: 6px;
            width: 100%;
            max-width: 100%;
            display: block; 
        }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 400px; }
        
        thead th {
            background-color: #f1f5f9;
            color: var(--brand-navy);
            text-align: left;
            padding: 12px 16px;
            position: sticky;
            top: 0;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            z-index: 10;
            white-space: nowrap;
        }
        
        tbody td {
            padding: 10px 16px;
            border-bottom: 1px solid #f1f5f9;
            color: var(--brand-slate);
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
        }

        @media (max-width: 600px) {
            .table-wrapper { border-radius: 4px; }
            table { font-size: 0.75rem; }
            th, td { padding: 8px 10px; }
            td:first-child, th:first-child { white-space: nowrap; min-width: 80px; }
            .savings-grid { grid-template-columns: 1fr; gap: 0.75rem; }
        }

        .year-row { background-color: #f8fafc; cursor: pointer; font-weight: 600; border-bottom: 1px solid #e2e8f0; }
        .year-row:hover { background-color: #f1f5f9; }
        .year-row td { color: var(--brand-navy); }
        .month-row { display: none; background-color: white; }
        .month-row.active { display: table-row; }
        .month-row td { padding-left: 24px; font-size: 0.8rem; }
        .toggle-icon { display: inline-block; width: 16px; text-align: center; transition: transform 0.2s; margin-left: 1rem; flex-shrink: 0; }
        .year-row.expanded .toggle-icon { transform: rotate(90deg); }
        .pmi-drop-row { background-color: #dcfce7 !important; }
        .one-time-row { background-color: #e0e7ff !important; }

        /* MODAL STYLES */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.5); z-index: 1000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        
        .modal-content {
            background: white; width: 90%; max-width: 500px;
            padding: 2rem; border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transform: translateY(20px); transition: transform 0.2s;
            max-height: 80vh; overflow-y: auto; 
        }
        .modal-overlay.open .modal-content { transform: translateY(0); }
        .modal-header { font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 1.5rem; }
        
        /* Updated .btn-cancel to match .btn-primary height */
        .btn-cancel { 
            background: transparent; 
            border: 1px solid var(--border-color); 
            color: var(--brand-slate); 
            padding: 0.75rem 1.5rem; 
            border-radius: 6px; 
            font-weight: 600; 
            cursor: pointer; 
        }
        .btn-cancel:hover { background: #f1f5f9; }

        /* POLICY TEXT STYLES */
        .policy-text h3 { font-size: 1rem; margin-top: 1rem; margin-bottom: 0.5rem; color: var(--brand-navy); }
        .policy-text p { font-size: 0.9rem; color: #475569; margin-bottom: 0.8rem; line-height: 1.6; }
        .policy-text ul { margin-left: 1.5rem; margin-bottom: 1rem; font-size: 0.9rem; color: #475569; }

        /* CONTENT ACCORDIONS - STYLE 3 (UNIFIED) */
        .content-section {
            max-width: 1100px;
            margin: 0 auto 3rem auto;
            padding: 0 1.5rem;
        }
        .content-card {
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            margin-bottom: 1rem;
        }
        .content-header {
            padding: 1.5rem 1.25rem 1.5rem 1.5rem; /* Tweak padding to push arrow right */
            font-weight: 700;
            color: var(--brand-navy);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            border-bottom: 1px solid #f1f5f9; /* Subtle divider when closed */
            border-left: 4px solid var(--brand-teal); /* The Key Feature: Left Accent */
            transition: all 0.2s;
        }
        .content-header:hover { 
            background: #f8fafc; 
            padding-left: 1.8rem; /* Slide Effect */
        }
        .content-header.active { 
            background: #f0fdfa; /* Very light teal bg when open */
            border-left-color: var(--brand-teal-dark); /* Darker accent when open */
            border-bottom: 1px solid var(--border-color);
        }
        
        .content-body {
            display: none;
            padding: 1.5rem;
            color: var(--brand-navy-light);
            line-height: 1.7;
            font-size: 0.95rem;
        }
        .content-body h3 { font-size: 1.1rem; margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--brand-navy); }
        .content-body h3:first-child { margin-top: 0; }
        .content-body p { margin-bottom: 1rem; color: #475569; }
        .content-body ul { margin-left: 1.5rem; margin-bottom: 1rem; color: #475569; }
        .content-body li { margin-bottom: 0.5rem; }

        /* Animations */
        @keyframes pulse-card {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(0.99); background-color: #f8fafc; }
            100% { opacity: 1; transform: scale(1); background-color: white; }
        }
        .pulse-animation { animation: pulse-card 0.3s ease-out; }

        .hidden { display: none !important; }
        .placeholder-state { text-align: center; color: var(--brand-slate); padding: 4rem 1rem; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; }

        footer { margin-top: auto; background: var(--brand-navy); color: #94a3b8; padding: 3rem 1.5rem; text-align: center; font-size: 0.85rem; width: 100%; }
        /* ADDED WRAPPING FOR FOOTER LINKS ON MOBILE */
        .footer-links { 
            margin-top: 1rem; 
            display: flex; 
            justify-content: center; 
            gap: 1.5rem; 
            flex-wrap: wrap; /* Ensures long text wraps */
        }
        .footer-links a { color: #94a3b8; text-decoration: none; transition: color 0.2s; cursor: pointer; }
        .footer-links a:hover { color: white; text-decoration: underline; }
        .disclaimer { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.75rem; color: #64748b; max-width: 800px; margin-left: auto; margin-right: auto; line-height: 1.6; }
    </style>
</head>
<body>

    <nav>
        <div class="nav-container">
            <div class="logo">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                Mortgage Planner
            </div>
            <div class="nav-links">
                <a href="#" onclick="openFeedback()">Feedback</a>
            </div>
        </div>
    </nav>

    <div id="feedbackModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">Send Feedback</div>
            
            <form action="https://formsubmit.co/jflazor@gmail.com" method="POST">
                <div class="input-group">
                    <label>Feedback Type</label>
                    <select name="type">
                        <option value="Feature Enhancement">Feature Enhancement Request</option>
                        <option value="Technical Issue">Technical Issue</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Name <span style="font-weight: 400; color: #94a3b8;">(Optional)</span></label>
                    <input type="text" name="name" placeholder="John Doe">
                </div>
                <div class="input-group">
                    <label>Email Address <span style="font-weight: 400; color: #94a3b8;">(Optional)</span></label>
                    <input type="email" name="email" placeholder="you@example.com">
                </div>
                <div class="input-group">
                    <label>Message</label>
                    <textarea name="message" rows="4" placeholder="Tell us what you think..." required style="resize: vertical;"></textarea>
                </div>
                <input type="hidden" name="_subject" value="Mortgage Planner Feedback">
                <input type="hidden" name="_captcha" value="false"> 
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeFeedback()">Cancel</button>
                    <button type="submit" class="btn-primary" style="width: auto; margin:0;">Submit Feedback</button>
                </div>
            </form>
        </div>
    </div>

    <div id="embedModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">Embed Calculator</div>
            <div class="policy-text">
                <p>Add this mortgage planner to your website for free. It's a great value-add for real estate blogs and agent sites.</p>
                <div style="background:#f8fafc; padding:15px; border-radius:6px; margin: 15px 0;">
                    <strong style="display:block; margin-bottom:8px; color:var(--brand-navy);">Instructions:</strong>
                    <ol style="margin-left: 20px; font-size: 0.9rem; color: #475569;">
                        <li style="margin-bottom:6px;">Copy the code snippet below.</li>
                        <li>Paste it into an <strong>"HTML Block"</strong> or <strong>"Code Widget"</strong> on your website (WordPress, Wix, Squarespace, etc).</li>
                    </ol>
                    <div style="margin-top: 12px; font-size: 0.85rem; color: var(--brand-teal-dark); border-top: 1px solid #e2e8f0; padding-top: 10px;">
                        <strong>ðŸ’¡ Pro Tip:</strong> Want to change the size? Adjust the <code>height="800"</code> number in the code to fit your page perfectly.
                    </div>
                </div>
                <label style="font-weight:600; margin-bottom:6px; display:block;">Code Snippet:</label>
                <textarea id="embedCodeBox" readonly style="width:100%; height:80px; font-family:monospace; font-size:0.85rem; padding:10px; border:1px solid #cbd5e1; border-radius:6px; background:#fff; resize:none;"></textarea>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeModal('embedModal')">Close</button>
                <button type="button" class="btn-primary" style="width: auto;" onclick="copyEmbedCode()">Copy Code</button>
            </div>
        </div>
    </div>

    <div id="emailSuccessModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div class="modal-header" style="border-bottom: none; padding-bottom: 0; margin-bottom: 1rem;">Mortgage Planner says:</div>
            <p style="color: #475569; margin-bottom: 1.5rem; line-height: 1.6;">
                We tried to open your email app!<br><br>
                If nothing happened, don't worryâ€”we copied the plan to your clipboard.<br><br>
                Just open your email and paste into the Email Message.
            </p>
            <button class="btn-primary" onclick="closeModal('emailSuccessModal')">OK</button>
        </div>
    </div>

    <div id="privacyModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">Privacy Policy</div>
            <div class="policy-text">
                <p><strong>Last Updated: January 2025</strong></p>
                <p>Your privacy is important to us. It is Mortgage Planner's policy to respect your privacy regarding any information we may collect from you across our website.</p>
                
                <h3>1. Information Collection</h3>
                <p>We do not ask for personal information unless we truly need it to provide a service (like our Feedback form). We do not store financial data entered into the calculator on our servers; all calculations happen locally in your browser.</p>
                
                <h3>2. Cookies and Third-Party Services</h3>
                <p>We use third-party services, such as Google Analytics, to improve our service. These third parties may use cookies to collect information.</p>
                
                <h3>3. Opting Out</h3>
                <p>Users may opt out of personalized advertising by visiting Google Ad Settings.</p>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-primary" style="width: auto;" onclick="closeModal('privacyModal')">Close</button>
            </div>
        </div>
    </div>

    <div id="termsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">Terms of Service & Disclaimer</div>
            <div class="policy-text">
                <p><strong>Last Updated: January 2025</strong></p>
                
                <h3>1. Educational Purpose Only</h3>
                <p>The Mortgage Planner tool is designed for educational and informational purposes only. It is intended to provide estimates based on the information you provide. It is not a financial institution, lender, or financial advisor.</p>
                
                <h3>2. No Financial Advice</h3>
                <p>The results provided by this calculator should not be construed as financial, legal, or tax advice. You should consult with a qualified professional before making any financial decisions.</p>
                
                <h3>3. Accuracy of Information</h3>
                <p>While we strive to keep the calculator accurate, we cannot guarantee the accuracy, completeness, or reliability of any results. Actual loan terms may vary.</p>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-primary" style="width: auto;" onclick="closeModal('termsModal')">Close</button>
            </div>
        </div>
    </div>

    <div class="hero">
        <h1>Mortgage Math, Simplified.</h1>
        <p>No ads. No sign-ups. Just the numbers you need.</p>
        
        <div class="hero-badges">
            <div class="badge-item">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                No Data Collection
            </div>
            <div class="badge-item">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                Instant Results
            </div>
            <div class="badge-item">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                Shareable Links
            </div>
        </div>
    </div>

    <div class="app-container">
        
        <div class="card">
            <h2>Loan Parameters</h2>
            
            <div class="split-inputs">
                <div class="input-group">
                    <label>Home Price ($)</label>
                    <div class="input-wrapper">
                        <span class="input-icon">$</span>
                        <input type="text" id="homePrice" class="has-left-icon" value="350,000" placeholder="350,000" onblur="formatInput(this)" oninput="updateDownPaymentHelper()">
                    </div>
                </div>

                <div class="input-group">
                    <div class="label-row">
                        <label>Down Payment</label>
                        <select id="downPaymentType" style="width: 45px; padding: 0 2px; text-align:center; font-weight:600;" onchange="updateDownIcon()">
                            <option value="percent">%</option>
                            <option value="dollar">$</option>
                        </select>
                    </div>
                    <div class="input-wrapper">
                        <span class="input-icon right" id="downIcon">%</span>
                        <input type="text" id="downPayment" class="has-right-icon" value="20" onblur="formatInput(this)" oninput="updateDownPaymentHelper()">
                    </div>
                    <div id="downPaymentHelper" class="helper-text"></div>
                </div>
            </div>

            <div class="split-inputs">
                <div class="input-group">
                    <label>Interest Rate</label>
                    <div class="input-wrapper">
                        <input type="number" id="interestRate" class="has-right-icon" value="6.5" step="0.1">
                        <span class="input-icon right">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <label>Term (Years)</label>
                    <input type="number" id="loanTerm" value="30">
                </div>
            </div>

            <div class="split-inputs">
                <div class="input-group">
                    <label>Prop. Tax ($/Yr)</label>
                    <div class="input-wrapper">
                        <span class="input-icon">$</span>
                        <input type="text" id="annualTax" class="has-left-icon" value="3,000" placeholder="0" onblur="formatInput(this)">
                    </div>
                </div>
                <div class="input-group">
                    <label>Insurance ($/Yr)</label>
                    <div class="input-wrapper">
                        <span class="input-icon">$</span>
                        <input type="text" id="annualIns" class="has-left-icon" value="1,200" placeholder="0" onblur="formatInput(this)">
                    </div>
                </div>
            </div>
            
            <div class="split-inputs">
                <div class="input-group">
                    <label>
                        Annual PMI Rate
                        <div class="tooltip-container">
                            <svg class="tooltip-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <span class="tooltip-text">Private Mortgage Insurance is usually required if down payment is under 20%.</span>
                        </div>
                    </label>
                    <div class="input-wrapper">
                        <input type="number" id="pmiRate" class="has-right-icon" value="0.5" step="0.1">
                        <span class="input-icon right">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <label>
                        Monthly HOA
                        <div class="tooltip-container">
                            <svg class="tooltip-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <span class="tooltip-text shift-left">Homeowners Association fees are separate from your mortgage but impact affordability.</span>
                        </div>
                    </label>
                    <div class="input-wrapper">
                        <span class="input-icon">$</span>
                        <input type="text" id="monthlyHOA" class="has-left-icon" value="" placeholder="0" onblur="formatInput(this)">
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <span id="advancedToggle" class="advanced-link" onclick="toggleAdvanced(); gtag('event', 'click_advanced_toggle', {'event_category': 'Engagement'});">(+) Advanced Options</span>
                <div id="advancedSection" class="advanced-content hidden">
                    
                    <div class="advanced-sub-header" style="margin-top: 0;">Annual Increases</div>
                    <div class="split-inputs three-col-mobile-fix" style="grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin-bottom: 1.5rem;">
                        <div class="input-group" style="margin-bottom:0;">
                            <label style="font-size: 0.75rem;">Tax %</label>
                            <div class="input-wrapper">
                                <input type="number" id="incTax" class="has-right-icon" value="0" step="0.1">
                                <span class="input-icon right">%</span>
                            </div>
                        </div>
                        <div class="input-group" style="margin-bottom:0;">
                            <label style="font-size: 0.75rem;">Ins. %</label>
                            <div class="input-wrapper">
                                <input type="number" id="incIns" class="has-right-icon" value="0" step="0.1">
                                <span class="input-icon right">%</span>
                            </div>
                        </div>
                        <div class="input-group" style="margin-bottom:0;">
                            <label style="font-size: 0.75rem;">HOA %</label>
                            <div class="input-wrapper">
                                <input type="number" id="incHOA" class="has-right-icon" value="0" step="0.1">
                                <span class="input-icon right">%</span>
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>
                            Extra Monthly Principal
                            <div class="tooltip-container">
                                <svg class="tooltip-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                <span class="tooltip-text">Added directly to your loan balance every month to pay it off faster.</span>
                            </div>
                        </label>
                        <div class="input-wrapper">
                            <span class="input-icon">$</span>
                            <input type="text" id="extraPrincipal" class="has-left-icon" value="" placeholder="0" onblur="formatInput(this)">
                        </div>
                    </div>

                    <div class="advanced-sub-header" style="margin-top: 1.5rem;">Extra One-Time Payments</div>
                    <div id="oneTimeContainer">
                        <div class="otp-row">
                            <input type="number" placeholder="Month #" class="otp-month" style="width: 40%;" min="1">
                            <div class="input-wrapper" style="flex: 1;">
                                <span class="input-icon">$</span>
                                <input type="text" placeholder="Amount" class="has-left-icon otp-amount" onblur="formatInput(this)">
                            </div>
                            <button class="otp-remove-btn" onclick="removeOneTimeRow(this)" title="Remove">Ã—</button>
                        </div>
                    </div>
                    <button class="otp-add-btn" onclick="addOneTimeRow()">
                        <span style="font-size: 1.2rem; font-weight:bold;">+</span> Add another payment
                    </button>

                </div>
            </div>

            <button id="calcBtn" class="btn-primary" onclick="calculate()">Plan Your Payment</button>

            <div style="margin-top: 1rem; display: flex; flex-direction: column; gap: 10px;">
                <button onclick="shareSite()" class="btn-secondary" id="shareBtn" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 0.8rem; background-color: #f1f5f9; border-color: #cbd5e1;">
                    <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                    Share this Plan
                </button>
                
                <button onclick="bookmarkPlan()" class="btn-secondary" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 0.8rem; border-style: dashed;">
                    <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>
                    Bookmark this Plan
                </button>
            </div>
        </div>

        <div class="card">
            <div id="placeholder" class="placeholder-state">
                <svg style="width: 56px; height: 56px; margin-bottom: 1rem; color: #cbd5e1;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                <p>Enter your details on the left to<br>generate your Mortgage Plan.</p>
            </div>

            <div id="results" class="hidden">
                <div class="results-header">
                    <h2>Your Plan Breakdown</h2>
                    <div class="results-actions">
                        <button class="btn-secondary" onclick="emailPlan()">Email Plan</button>
                        <button class="btn-secondary" onclick="exportPDF()">Print / Save PDF</button>
                    </div>
                </div>

                <div class="summary-cards">
                    <div class="mini-card">
                        <small>Initial Monthly Payment</small>
                        <strong class="highlight" id="displayTotalMonthly">$0</strong>
                    </div>
                    <div class="mini-card">
                        <small>Principal & Interest</small>
                        <strong id="displayPI">$0</strong>
                    </div>
                    <div class="mini-card">
                        <small>Taxes, Insurance, & Other Fees</small>
                        <strong id="displayTaxInsPMI">$0</strong>
                    </div>
                </div>

                <div id="savingsDisplay" class="savings-card">
                    <div class="savings-header">
                        <svg style="width:20px;height:20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                        Early Payoff Strategy
                    </div>
                    <div class="savings-grid">
                        <div class="savings-item">
                            <small>Total Saved</small>
                            <strong id="saveAmount">$0</strong>
                        </div>
                        <div class="savings-item">
                            <small>Time Saved</small>
                            <strong id="saveTime">0 Years</strong>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <p style="font-size: 1rem; color: var(--brand-navy); margin-bottom: 4px;">
                        Loan Principal: <strong id="displayLoanPrincipal">$0</strong>
                    </p>
                    <p id="downPaymentDisplayResult" style="font-size: 0.85rem; color: #64748b; margin-bottom: 4px;"></p>
                </div>

                <div class="chart-container">
                    <canvas id="myChart"></canvas>
                </div>

                <p id="pmiStatus" style="font-size:0.8rem; color:#d97706; text-align:center; margin-top: -10px; margin-bottom: 1.5rem;"></p>

                <div class="lifetime-totals">
                    <div class="lifetime-header">Total Cost Breakdown</div>
                    <div class="lifetime-grid">
                        <div class="lifetime-item">
                            <span class="lifetime-label">Principal</span>
                            <span class="lifetime-value" id="ltPrincipal">$0</span>
                        </div>
                        <div class="lifetime-item">
                            <span class="lifetime-label">Interest</span>
                            <span class="lifetime-value" id="ltInterest">$0</span>
                        </div>
                        <div class="lifetime-item">
                            <span class="lifetime-label">Taxes</span>
                            <span class="lifetime-value" id="ltTax">$0</span>
                        </div>
                        <div class="lifetime-item">
                            <span class="lifetime-label">Insurance</span>
                            <span class="lifetime-value" id="ltIns">$0</span>
                        </div>
                        <div class="lifetime-item" id="ltPMIBox" style="display:none;">
                            <span class="lifetime-label">PMI</span>
                            <span class="lifetime-value" id="ltPMI">$0</span>
                        </div>
                        <div class="lifetime-item" id="ltHOABox" style="display:none;">
                            <span class="lifetime-label">HOA</span>
                            <span class="lifetime-value" id="ltHOA">$0</span>
                        </div>
                    </div>
                    <div class="lifetime-total-row">
                        <span class="lifetime-total-label">TOTAL LIFETIME COST</span>
                        <span class="lifetime-total-val" id="ltTotal">$0</span>
                    </div>
                </div>

                <div style="margin-bottom: 1rem; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px;">
                    <h2 style="font-size: 1.1rem; margin-bottom: 0.25rem; border: none; padding: 0;">Amortization Schedule</h2>
                    <p style="font-size: 0.8rem; color: #64748b;">(Click rows to expand details)</p>
                </div>
                
                <div class="table-wrapper">
                    <table id="amortizationTable">
                        <thead>
                            <tr>
                                <th>Year / Month</th>
                                <th>Interest</th>
                                <th>Principal</th>
                                <th>Tax, Ins. & Fees</th>
                                <th>Total Pmt</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="embed-cta">
        <a onclick="openModal('embedModal'); gtag('event', 'click_embed_open', {'event_category': 'Engagement'});">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
            Embed this Calculator on your Website
        </a>
    </div>

    <div class="content-section">
        <h2 style="font-size: 1.25rem; margin-bottom: 1rem; text-align: center; color: var(--brand-navy);">Mortgage Guide & FAQs</h2>
        
        <div class="content-card">
            <div class="content-header" onclick="toggleContent(this)">
                <span>How to Use This Mortgage Planner</span>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="content-body">
                <h3>Step-by-Step Instructions</h3>
                <p>1. <strong>Enter Loan Details:</strong> Input your home price, down payment, interest rate, and loan term in the "Loan Parameters" section.</p>
                <p>2. <strong>Add Expenses:</strong> Fill in your estimated annual property tax and insurance. If you have an HOA fee, include that as a monthly cost.</p>
                <p>3. <strong>Check Advanced Options:</strong> This is a specialized <strong>calculator for mortgage with annual tax increase</strong> capability. Click "Advanced Options" to set a percentage for Tax, Insurance, or HOA increases to see how your monthly payment will change over 10 or 20 years.</p>
                <p>4. <strong>Analyze Results:</strong> Click "Plan Your Payment" to generate a full visualization. Use the interactive <strong>amortization schedule with PMI drop off date</strong> to see exactly when you will stop paying mortgage insurance.</p>
                <p>5. <strong>View Examples:</strong> Check the 'Examples' section below to see how strategies like adding $100/mo or annual bonuses can save you thousands using your own numbers.</p>
                <p>6. <strong>Share Your Plan:</strong> Found a strategy that saves you money? Click the "Share this Plan" button to send a live link to your spouse or realtor. They will see your exact numbers instantly.</p>
            </div>
        </div>

        <div class="content-card"> 
            <div class="content-header" onclick="toggleContent(this)">
                <span>Strategies to Save Thousands in Interest</span>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="content-body">
                <h3>The Power of Extra Payments</h3>
                <p>One of the most effective ways to save money is by making extra principal payments. Because interest is calculated on your remaining balance, every dollar you pay down early reduces the interest charged for every single month thereafter.</p>
                <ul>
                    <li><strong>Round Up:</strong> Rounding your payment up to the nearest $100 can shave years off your loan.</li>
                    <li><strong>The "13th Payment":</strong> Making one extra full payment per year can reduce a 30-year mortgage to roughly 22-23 years.</li>
                    <li><strong>Recasting:</strong> If you come into a lump sum (like a bonus), apply it as a "One-Time Payment" in this calculator to see how it impacts your timeline.</li>
                </ul>
            </div>
        </div>

        <div class="content-card">
            <div class="content-header" onclick="toggleContent(this)">
                <span>Examples: The Power of Early Payoff</span>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="content-body">
                <p>Click a button below to instantly apply these scenarios to your current loan details:</p>
                
                <div class="example-row">
                    <button class="btn-example-small" onclick="loadExample('baseline')">Baseline (Reset)</button>
                    <span class="example-desc">Clear extra payments to see the standard loan path.</span>
                </div>
                
                <div class="example-row">
                    <button class="btn-example-small" onclick="loadExample('extra100')">+$100 / Month</button>
                    <span class="example-desc">See the impact of a small monthly habit.</span>
                </div>
                
                <div class="example-row">
                    <button class="btn-example-small" onclick="loadExample('lumpSum')">Year 3 Bonus</button>
                    <span class="example-desc">Simulate a one-time $10k payment in Year 3.</span>
                </div>
                
                <div class="example-row">
                    <button class="btn-example-small" onclick="loadExample('aggressive')">Aggressive</button>
                    <span class="example-desc">Add $500/month to slash years off the term.</span>
                </div>
            </div>
        </div>

        <div class="content-card">
            <div class="content-header" onclick="toggleContent(this)">
                <span>Frequently Asked Questions</span>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="content-body">
                <h3>What is PMI and when does it go away?</h3>
                <p>PMI (Private Mortgage Insurance) is usually required if you put down less than 20%. It protects the lender, not you. This tool automatically calculates your loan-to-value ratio (LTV) and highlights the specific month your PMI is removed on the schedule.</p>
                
                <h3>How do Annual Tax and HOA increases affect me?</h3>
                <p>Unlike a fixed-rate mortgage payment, taxes and fees rise over time. Most calculators ignore this, but it can make a home unaffordable in 10 years. Use the Advanced Options to <strong>calculate the impact of HOA fee increase on mortgage</strong> payments to ensure you remain within budget long-term.</p>
                
                <h3>Should I pay off my mortgage or invest?</h3>
                <p>This depends on your interest rate versus expected investment returns. If your mortgage rate is 7% and the market returns 5%, paying off the debt is a guaranteed 7% return. Use this tool to see exactly how much interest you save by paying early.</p>
            </div>
        </div>
    </div>

    <div class="coffee-section">
        <p>Found this tool helpful?</p>
        <a href="https://buymeacoffee.com/mortgageplanner" target="_blank" class="btn-coffee" onclick="gtag('event', 'click_coffee', {'event_category': 'Conversion', 'event_label': 'Buy Me Coffee'});">
            â˜• Buy me a coffee
        </a>
    </div>

    <footer>
        <p>Â© <span id="copyrightYear">2024</span> Mortgage Planner. All rights reserved.</p>
        <div class="footer-links">
            <a onclick="openModal('privacyModal')">Privacy Policy</a>
            <a onclick="openModal('termsModal')">Terms of Service</a>
        </div>
        <div class="disclaimer">
            <p><strong>Disclaimer:</strong> This tool is provided for visualization and planning purposes only. It calculates estimates based on the inputs provided. Future tax, insurance, and HOA increases are projections and may vary. Please contact a qualified loan officer or financial institution for official loan estimates.</p>
        </div>
    </footer>

    <script>
        // SET DYNAMIC YEAR
        document.getElementById('copyrightYear').innerText = new Date().getFullYear();

        // --- GENERIC MODAL FUNCTIONS ---
        function openModal(id) {
            // Special handling for Embed Modal to generate the code
            if(id === 'embedModal') {
                const url = window.location.origin + window.location.pathname;
                const code = `<iframe src="${url}?mode=embed" width="100%" height="800" frameborder="0" style="border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.05);"></iframe>`;
                document.getElementById('embedCodeBox').value = code;
            }
            document.getElementById(id).classList.add('open');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('open');
        }

        // COPY EMBED CODE
        function copyEmbedCode() {
            const copyText = document.getElementById("embedCodeBox");
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            navigator.clipboard.writeText(copyText.value).then(() => {
                const btn = document.querySelector('#embedModal .btn-primary');
                const originalText = btn.innerText;
                btn.innerText = "Copied!";
                setTimeout(() => { btn.innerText = originalText; }, 2000);
            });
            // NEW TRACKING
            if(typeof gtag === 'function') {
                gtag('event', 'click_embed_copy', {'event_category': 'Conversion'});
            }
        }

        // WRAPPERS FOR SPECIFIC BUTTONS
        function openFeedback() { openModal('feedbackModal'); }
        function closeFeedback() { closeModal('feedbackModal'); }

        // --- CONTENT ACCORDION TOGGLE ---
        function toggleContent(header) {
            const body = header.nextElementSibling;
            const icon = header.querySelector('.toggle-icon');
            
            if (body.style.display === "block") {
                body.style.display = "none";
                header.classList.remove('active');
                icon.style.transform = "rotate(0deg)";
            } else {
                body.style.display = "block";
                header.classList.add('active');
                icon.style.transform = "rotate(180deg)";
            }
        }

        // --- URL SHARE LOGIC ---
        function getShareableLink() {
            const params = new URLSearchParams();
            
            // Map inputs to URL params
            params.set('p', getCleanNumber('homePrice'));
            params.set('d', getCleanNumber('downPayment'));
            params.set('dt', document.getElementById('downPaymentType').value);
            params.set('r', document.getElementById('interestRate').value);
            params.set('t', document.getElementById('loanTerm').value);
            params.set('tax', getCleanNumber('annualTax'));
            params.set('ins', getCleanNumber('annualIns'));
            params.set('pmi', document.getElementById('pmiRate').value);
            params.set('hoa', getCleanNumber('monthlyHOA'));
            
            // Advanced
            const extra = getCleanNumber('extraPrincipal');
            if(extra > 0) params.set('ex', extra);
            
            const iTax = document.getElementById('incTax').value;
            if(iTax > 0) params.set('it', iTax);
            
            const iIns = document.getElementById('incIns').value;
            if(iIns > 0) params.set('ii', iIns);
            
            const iHoa = document.getElementById('incHOA').value;
            if(iHoa > 0) params.set('ih', iHoa);

            return window.location.origin + window.location.pathname + '?' + params.toString();
        }

        function initFromURL() {
            const params = new URLSearchParams(window.location.search);
            
            // CHECK FOR EMBED MODE
            if(params.has('mode') && params.get('mode') === 'embed') {
                document.body.classList.add('embed-mode');
            }

            if(params.size === 0) return;

            // Helper to set values
            const setVal = (id, key, isCurrency = false) => {
                if(params.has(key)) {
                    const el = document.getElementById(id);
                    el.value = params.get(key);
                    if(isCurrency) formatInput(el);
                }
            };

            setVal('homePrice', 'p', true);
            setVal('downPayment', 'd', true); // will fix format after type check
            
            if(params.has('dt')) {
                const type = params.get('dt');
                document.getElementById('downPaymentType').value = type;
                updateDownIcon(); // Update the % or $ symbol
                // Re-format down payment based on type
                formatInput(document.getElementById('downPayment'));
            }

            setVal('interestRate', 'r');
            setVal('loanTerm', 't');
            setVal('annualTax', 'tax', true);
            setVal('annualIns', 'ins', true);
            setVal('pmiRate', 'pmi');
            setVal('monthlyHOA', 'hoa', true);
            
            // Advanced handling
            let advancedUsed = false;
            if(params.has('ex')) { setVal('extraPrincipal', 'ex', true); advancedUsed = true; }
            if(params.has('it')) { setVal('incTax', 'it'); advancedUsed = true; }
            if(params.has('ii')) { setVal('incIns', 'ii'); advancedUsed = true; }
            if(params.has('ih')) { setVal('incHOA', 'ih'); advancedUsed = true; }

            // If advanced features used, open the accordion
            if(advancedUsed) {
                document.getElementById('advancedSection').classList.remove('hidden');
                document.getElementById('advancedToggle').innerText = "(-) Advanced Options";
            }

            // UPDATE: Call helper update before calculation
            updateDownPaymentHelper();

            // Auto Calculate
            calculate();
        }

        // ---- IFRAME-SAFE SHARE FUNCTIONS ----

        function shareSite() {
            // Focus helps in some iframe contexts
            window.focus();
            if(document.activeElement) document.activeElement.blur();
            
            const shareUrl = getShareableLink();
            const btn = document.getElementById('shareBtn'); // Assuming you add id="shareBtn" to the button
            const originalText = btn ? btn.innerText : "Share this Plan";
            
            // Track Event
            if(typeof gtag === 'function') {
                gtag('event', 'click_share', {
                    'event_category': 'Engagement',
                    'event_label': 'Share Button'
                });
            }

            // Try modern share first (works on mobile often)
            if (navigator.share) {
                navigator.share({
                    title: 'Mortgage Plan',
                    text: 'Check out this mortgage plan',
                    url: shareUrl
                }).catch(err => {
                    // Fallback to Clipboard if share fails/cancelled
                    copyToClipboardFallback(shareUrl, btn, originalText);
                });
            } else {
                // Desktop Fallback
                copyToClipboardFallback(shareUrl, btn, originalText);
            }
        }

        function copyToClipboardFallback(text, btn, originalText) {
            // Robust clipboard copy using deprecated execCommand for iframes
             const textArea = document.createElement("textarea");
             textArea.value = text;
             textArea.style.position = "fixed";  //avoid scrolling to bottom
             document.body.appendChild(textArea);
             textArea.focus();
             textArea.select();
             
             try {
                var successful = document.execCommand('copy');
                if(successful) {
                    if(btn) {
                        btn.innerHTML = `
                            <svg style="width:18px;height:18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            Link Copied!
                        `;
                        setTimeout(() => { btn.innerText = originalText; }, 2000);
                    } else {
                        alert("Link copied to clipboard!");
                    }
                } else {
                    alert("Could not copy link automatically. Please copy the URL from the address bar.");
                }
             } catch (err) {
                 alert("Could not copy link automatically. Please copy the URL from the address bar.");
             }
             document.body.removeChild(textArea);
        }

        function bookmarkPlan() {
            const newUrl = getShareableLink();
            
            // 1. SILENTLY UPDATE URL BAR
            // Note: In an iframe, this updates the iframe URL, not the parent window URL (usually restricted).
            // But it's good practice for standalone use.
            window.history.pushState({}, '', newUrl);
            
            // Track Event
            if(typeof gtag === 'function') {
                gtag('event', 'click_save_bookmark', {
                    'event_category': 'Engagement',
                    'event_label': 'Bookmark Button'
                });
            }
            
            alert('Your custom scenario is now in the address bar.\n\nPress Ctrl+D (Windows) or Cmd+D (Mac) to bookmark this specific plan!');
        }

        // IFRAME-SAFE EMAIL FUNCTION (FIXED)
        function emailPlan() {
            const shareUrl = getShareableLink();
            const totalMonthly = document.getElementById('displayTotalMonthly').innerText;
            const principal = document.getElementById('displayLoanPrincipal').innerText;
            const price = document.getElementById('homePrice').value; 
            const term = document.getElementById('loanTerm').value; 
            
            // Track Event
            if(typeof gtag === 'function') {
                gtag('event', 'click_email_plan', {
                    'event_category': 'Engagement',
                    'event_label': 'Email Plan Button'
                });
            }

            const subject = `Mortgage Planner | $${price} home, ${totalMonthly}/mo, ${term} yr.`;
            const body = `Here is the mortgage plan I calculated using Mortgage Planner:\n\nLoan Amount: ${principal}\nInitial Monthly Payment: ${totalMonthly}\n\nClick this link to see the full interactive breakdown (taxes, HOA, and extra payments included):\n${shareUrl}`;

            // 1. FORCE COPY TO CLIPBOARD (Robust Method for Iframes)
            const textArea = document.createElement("textarea");
            textArea.value = body;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('Fallback copy failed', err);
            }
            
            document.body.removeChild(textArea);

            // 2. OPEN EMAIL CLIENT (Using Invisible Link Click)
            // This is safer than window.location.href or window.open in some restrictive iframes
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            const link = document.createElement('a');
            link.href = mailtoLink;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            
            // Cleanup
            setTimeout(function() {
                document.body.removeChild(link);
            }, 100);
            
            // 3. SHOW SUCCESS MODAL
            openModal('emailSuccessModal');
        }

        // --- NEW: EXAMPLE LOADER FUNCTION (PRESERVES USER INPUTS) ---
        function loadExample(type) {
            // NOTE: We do NOT clear Home Price, Rate, Term, etc.
            // We only reset the "Advanced / Extra Payment" fields.
            
            document.getElementById('extraPrincipal').value = "";
            document.getElementById('incTax').value = "0";
            document.getElementById('incIns').value = "0";
            document.getElementById('incHOA').value = "0";
            
            // Reset One-Time Rows to just one empty row
            document.getElementById('oneTimeContainer').innerHTML = `
                <div class="otp-row">
                    <input type="number" placeholder="Month #" class="otp-month" style="width: 40%;" min="1">
                    <div class="input-wrapper" style="flex: 1;">
                        <span class="input-icon">$</span>
                        <input type="text" placeholder="Amount" class="has-left-icon otp-amount" onblur="formatInput(this)">
                    </div>
                    <button class="otp-remove-btn" onclick="removeOneTimeRow(this)" title="Remove">Ã—</button>
                </div>`;

            // Apply Specific Scenario Logic
            if (type === 'extra100') {
                document.getElementById('extraPrincipal').value = "100";
                document.getElementById('advancedSection').classList.remove('hidden');
                document.getElementById('advancedToggle').innerText = "(-) Advanced Options";
            } 
            else if (type === 'aggressive') {
                document.getElementById('extraPrincipal').value = "500";
                document.getElementById('advancedSection').classList.remove('hidden');
                document.getElementById('advancedToggle').innerText = "(-) Advanced Options";
            }
            else if (type === 'lumpSum') {
                const row = document.querySelector('.otp-row');
                row.querySelector('.otp-month').value = 36;
                row.querySelector('.otp-amount').value = "10,000";
                document.getElementById('advancedSection').classList.remove('hidden');
                document.getElementById('advancedToggle').innerText = "(-) Advanced Options";
            }
            
            // NEW TRACKING
            if(typeof gtag === 'function') {
                gtag('event', 'click_example_load', {'event_category': 'Engagement', 'event_label': type});
            }

            // Run Updates
            updateDownIcon(); 
            updateDownPaymentHelper(); 
            calculate(); 
        }

        let currentSchedule = [];
        let myChart = null;
        let pmiDropMonth = 0; 

        // 1. HELPERS
        function cleanString(str) {
            if(!str) return 0;
            const cleaned = String(str).replace(/[^0-9.]/g, '');
            const parsed = parseFloat(cleaned);
            return isNaN(parsed) ? 0 : parsed;
        }

        function toCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function getCleanNumber(id) {
            const el = document.getElementById(id);
            if (!el) return 0;
            return cleanString(el.value);
        }

        function formatInput(input) {
            let val = input.value.replace(/[^0-9.]/g, ''); 
            if(val) {
                let number = parseFloat(val);
                input.value = number.toLocaleString('en-US'); 
            }
        }

        // 2. UI INTERACTIONS
        function toggleAdvanced() {
            const section = document.getElementById('advancedSection');
            const toggleBtn = document.getElementById('advancedToggle');
            section.classList.toggle('hidden');
            toggleBtn.innerText = section.classList.contains('hidden') ? "(+) Advanced Options" : "(-) Advanced Options";
        }

        function updateDownIcon() {
            const type = document.getElementById('downPaymentType').value;
            const icon = document.getElementById('downIcon');
            const input = document.getElementById('downPayment');
            const helper = document.getElementById('downPaymentHelper');

            if (type === 'percent') {
                icon.innerText = '%';
                icon.classList.add('right');
                input.classList.remove('has-left-icon');
                input.classList.add('has-right-icon');
                updateDownPaymentHelper(); // Trigger helper calculation
            } else {
                icon.innerText = '$';
                icon.classList.remove('right');
                input.classList.remove('has-right-icon');
                input.classList.add('has-left-icon');
                helper.innerText = ''; // Clear helper if dollar mode
            }
        }

        function updateDownPaymentHelper() {
            const type = document.getElementById('downPaymentType').value;
            const helper = document.getElementById('downPaymentHelper');
            const input = document.getElementById('downPayment');
            
            if (type === 'percent') {
                const price = getCleanNumber('homePrice');
                let percent = getCleanNumber('downPayment');
                
                // NEW: Auto-correct if user types > 99
                if (percent > 99) {
                    percent = 99;
                    input.value = "99";
                }

                if (price > 0 && percent > 0) {
                    const amount = price * (percent / 100);
                    // UPDATE: Changed text format here
                    helper.innerText = `Amount: ${toCurrency(amount)}`;
                } else {
                    helper.innerText = '';
                }
            } else {
                helper.innerText = '';
            }
        }

        function addOneTimeRow() {
            const container = document.getElementById('oneTimeContainer');
            const div = document.createElement('div');
            div.className = 'otp-row';
            div.innerHTML = `
                <input type="number" placeholder="Month #" class="otp-month" style="width: 40%;" min="1">
                <div class="input-wrapper" style="flex: 1;">
                    <span class="input-icon">$</span>
                    <input type="text" placeholder="Amount" class="has-left-icon otp-amount" onblur="formatInput(this)">
                </div>
                <button class="otp-remove-btn" onclick="removeOneTimeRow(this)" title="Remove">Ã—</button>
            `;
            container.appendChild(div);
        }

        function removeOneTimeRow(btn) {
            const row = btn.parentElement;
            row.remove();
        }

        function toggleYear(year) {
            const rows = document.querySelectorAll(`.year-${year}`);
            const yearRow = document.getElementById(`year-header-${year}`);
            
            let isExpanding = false;
            rows.forEach(row => {
                if(row.classList.contains('active')) {
                    row.classList.remove('active');
                } else {
                    row.classList.add('active');
                    isExpanding = true;
                }
            });

            if(isExpanding) yearRow.classList.add('expanded');
            else yearRow.classList.remove('expanded');
        }

        // --- MAIN CALCULATION ---
        function calculate() {
            try {
                // TRACKING EVENT: CALCULATION (RENAMED)
                if(typeof gtag === 'function') {
                    gtag('event', 'click_calculate', {
                        'event_category': 'Engagement',
                        'event_label': 'Mortgage Calculation'
                    });
                }

                // UI: Button Effect
                const btn = document.getElementById('calcBtn');
                const origText = btn.innerText;
                btn.innerText = "Updating...";
                
                // UI: Pulse Effect
                const resultsDiv = document.getElementById('results');
                resultsDiv.classList.remove('pulse-animation');
                void resultsDiv.offsetWidth; 
                resultsDiv.classList.add('pulse-animation');

                // INPUTS
                const homePrice = getCleanNumber('homePrice');
                const annualTax = getCleanNumber('annualTax');
                const annualIns = getCleanNumber('annualIns');
                const monthlyHOA = getCleanNumber('monthlyHOA'); 
                const extraPrincipal = getCleanNumber('extraPrincipal'); 

                const monthlyTax = annualTax / 12;
                const monthlyIns = annualIns / 12;

                const incTaxRate = parseFloat(document.getElementById('incTax').value) || 0;
                const incInsRate = parseFloat(document.getElementById('incIns').value) || 0;
                const incHOARate = parseFloat(document.getElementById('incHOA').value) || 0;

                const rRaw = parseFloat(document.getElementById('interestRate').value) || 0;
                const r = rRaw / 100 / 12;
                const nRaw = parseFloat(document.getElementById('loanTerm').value) || 0;
                const n = nRaw * 12;
                
                const pmiRateAnnual = parseFloat(document.getElementById('pmiRate').value) || 0;
                const pmiRateMonthly = pmiRateAnnual / 100;

                // Down Payment
                const downVal = getCleanNumber('downPayment');
                const downType = document.getElementById('downPaymentType').value;
                let downAmount = 0;
                
                // SAFETY CHECK: Ensure percent doesn't exceed 99 on calculation either
                if(downType === 'percent') {
                    if(downVal > 99) {
                        alert("Down payment percentage cannot exceed 99%.");
                        document.getElementById('downPayment').value = "99";
                        downAmount = homePrice * 0.99;
                    } else {
                        downAmount = homePrice * (downVal / 100);
                    }
                } else {
                    downAmount = downVal;
                }

                const P = homePrice - downAmount;

                // Validations
                if(!homePrice || !n) {
                    alert("Please fill in Home Price and Loan Term.");
                    btn.innerText = origText;
                    return;
                }
                if(P <= 0) {
                    alert("Down payment cannot be larger than home price.");
                    btn.innerText = origText;
                    return;
                }

                // OTP Logic
                const otpMap = {}; 
                const otpRows = document.querySelectorAll('.otp-row');
                otpRows.forEach(row => {
                    const monthInput = row.querySelector('.otp-month');
                    const amtInput = row.querySelector('.otp-amount');
                    if(monthInput && amtInput) {
                        const m = parseInt(monthInput.value);
                        const amt = cleanString(amtInput.value);
                        if(!isNaN(m) && m > 0 && amt > 0) {
                            if(otpMap[m]) otpMap[m] += amt;
                            else otpMap[m] = amt;
                        }
                    }
                });
                
                // CHECK FOR EXTRA PAYMENTS (To control Savings Box visibility)
                let hasExtraPayments = false;
                if(extraPrincipal > 0) hasExtraPayments = true;
                if(Object.keys(otpMap).length > 0) hasExtraPayments = true;

                // PMI
                let monthlyPMI = 0;
                const ltv = (P / homePrice); 
                const hasPMI = ltv > 0.80; 
                pmiDropMonth = 0;
                
                if(hasPMI) {
                    monthlyPMI = (P * pmiRateMonthly) / 12;
                    // UPDATED: Now includes dollar amount
                    document.getElementById('pmiStatus').innerText = `* Includes ${toCurrency(monthlyPMI)}/mo PMI (See schedule for removal date)`;
                } else {
                    document.getElementById('pmiStatus').innerText = "No PMI required (Down payment â‰¥ 20%)";
                }

                // P&I
                let monthlyPI = 0;
                if (r === 0) {
                    monthlyPI = P / n;
                } else {
                    monthlyPI = P * (r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
                }
                
                let currentMonthlyTax = annualTax / 12;
                let currentMonthlyIns = annualIns / 12;
                let currentMonthlyHOA = monthlyHOA;

                const initialTotalMonthly = monthlyPI + currentMonthlyTax + currentMonthlyIns + monthlyPMI + currentMonthlyHOA;

                // --- 1. BASELINE CALCULATION (NO EXTRA PAYMENTS) ---
                let baselineBalance = P;
                let baselineTotalInterest = 0;
                let baselineMonths = 0;
                
                // Track baseline PMI total
                let baselinePMITotal = 0;
                let baselinePMI = monthlyPMI; 
                let baselinePMIDropMonth = 0; // Capture when it drops in baseline

                // Simple baseline loop to get total interest if user paid minimums
                for(let b=1; b<=n; b++) {
                    // Update Balance FIRST (Standardize Order)
                    let bInt = baselineBalance * r;
                    let bPrin = monthlyPI - bInt;
                    if(bPrin > baselineBalance) bPrin = baselineBalance;
                    
                    baselineBalance -= bPrin;
                    
                    // THEN Check PMI (using new balance)
                    if (hasPMI) {
                        if(baselineBalance > (homePrice * 0.8)) {
                            baselinePMI = monthlyPMI;
                        } else {
                            if(baselinePMIDropMonth === 0) baselinePMIDropMonth = b;
                            baselinePMI = 0;
                        }
                        baselinePMITotal += baselinePMI;
                    }
                    
                    baselineTotalInterest += bInt;

                    if(baselineBalance <= 0.01) {
                        baselineMonths = b;
                        break;
                    }
                }
                if(baselineMonths === 0) baselineMonths = n; // If not paid off early in logic

                // --- 2. NEW CALCULATION (WITH EXTRA PAYMENTS) ---
                let balance = P;
                currentSchedule = [];
                const previewBody = document.getElementById('previewTableBody');
                let tableHTML = "";
                
                let yearlyInt = 0, yearlyPrin = 0, yearlyFees = 0, yearlyTotal = 0;
                let monthBuffer = [];
                let newTotalInterest = 0;
                let newPMITotal = 0; // NEW: Track PMI for strategy
                let newPayoffMonth = 0;
                
                // LIFETIME TOTAL TRACKING
                let totalLifetimeTax = 0;
                let totalLifetimeIns = 0;
                let totalLifetimeHOA = 0;
                let totalLifetimePMI = 0;

                for(let i=1; i<=n; i++) {
                    const currentYear = Math.ceil(i/12);

                    // Increases
                    if (i > 1 && (i - 1) % 12 === 0) {
                        currentMonthlyTax *= (1 + (incTaxRate / 100));
                        currentMonthlyIns *= (1 + (incInsRate / 100));
                        currentMonthlyHOA *= (1 + (incHOARate / 100));
                    }

                    let interest = balance * r;
                    let principal = monthlyPI - interest;
                    
                    let oneTimePayment = otpMap[i] || 0; 
                    let totalPrincipalPayment = principal + extraPrincipal + oneTimePayment;
                    
                    if(totalPrincipalPayment > balance) totalPrincipalPayment = balance;

                    balance -= totalPrincipalPayment;
                    if(balance < 0) balance = 0;
                    
                    // Track Interest
                    newTotalInterest += interest;

                    // PMI Removal
                    let currentPMI = 0;
                    let rowClass = "month-row year-" + currentYear;
                    
                    if(oneTimePayment > 0) rowClass += " one-time-row";

                    if(hasPMI) {
                        if(balance > (homePrice * 0.8)) {
                            currentPMI = monthlyPMI;
                        } else if(pmiDropMonth === 0) {
                            currentPMI = 0;
                            pmiDropMonth = i; 
                            rowClass += " pmi-drop-row"; 
                        } else {
                            currentPMI = 0;
                        }
                    }
                    
                    // Track New PMI Total
                    newPMITotal += currentPMI;
                    
                    // TRACK LIFETIME TOTALS
                    totalLifetimeTax += currentMonthlyTax;
                    totalLifetimeIns += currentMonthlyIns;
                    totalLifetimeHOA += currentMonthlyHOA;
                    totalLifetimePMI += currentPMI;

                    const monthlyFees = currentMonthlyTax + currentMonthlyIns + currentMonthlyHOA + currentPMI;
                    const monthTotalPay = interest + totalPrincipalPayment + monthlyFees;

                    // Add to Totals
                    yearlyInt += interest;
                    yearlyPrin += totalPrincipalPayment;
                    yearlyFees += monthlyFees;
                    yearlyTotal += monthTotalPay;

                    const rowData = {
                        num: i,
                        year: currentYear,
                        int: interest,
                        prin: totalPrincipalPayment,
                        fees: monthlyFees,
                        bal: balance,
                        total: monthTotalPay,
                        pmi: currentPMI
                    };
                    currentSchedule.push(rowData);

                    // Buffer Month Row HTML
                    monthBuffer.push(`
                        <tr class="${rowClass}">
                            <td>Month ${i} ${rowData.pmi===0 && pmiDropMonth===i ? '(PMI Removed)' : ''}</td>
                            <td>${toCurrency(interest)}</td>
                            <td>${toCurrency(totalPrincipalPayment)}</td>
                            <td>${toCurrency(monthlyFees)}</td>
                            <td>${toCurrency(monthTotalPay)}</td>
                            <td>${toCurrency(balance)}</td>
                        </tr>
                    `);

                    // END OF YEAR or PAID OFF: Render Group
                    if(i % 12 === 0 || balance <= 0.01) {
                        const yearId = `year-header-${currentYear}`;
                        tableHTML += `
                            <tr class="year-row" id="${yearId}" onclick="toggleYear(${currentYear})">
                                <td><span class="toggle-icon">â–¶</span> Year ${currentYear} Summary</td>
                                <td>${toCurrency(yearlyInt)}</td>
                                <td>${toCurrency(yearlyPrin)}</td>
                                <td>${toCurrency(yearlyFees)}</td>
                                <td>${toCurrency(yearlyTotal)}</td>
                                <td>${toCurrency(balance)}</td>
                            </tr>
                        `;
                        tableHTML += monthBuffer.join('');
                        
                        // Reset for next year
                        monthBuffer = [];
                        yearlyInt = 0; yearlyPrin = 0; yearlyFees = 0; yearlyTotal = 0;
                    }

                    if(balance <= 0.01) {
                        newPayoffMonth = i;
                        break;
                    }
                }
                
                // If never paid off in loop (e.g. standard 30 yr), set to N
                if(newPayoffMonth === 0) newPayoffMonth = n;

                previewBody.innerHTML = tableHTML;

                // --- 3. COMPARE AND SHOW SAVINGS (Now Includes PMI) ---
                const interestSaved = baselineTotalInterest - newTotalInterest;
                const pmiSaved = baselinePMITotal - newPMITotal;
                const totalMoneySaved = interestSaved + pmiSaved; // Combined Savings
                
                const monthsSaved = baselineMonths - newPayoffMonth;
                const savingsBox = document.getElementById('savingsDisplay');
                
                // Only show if savings are significant AND user entered extras
                if(hasExtraPayments && (totalMoneySaved > 1 || monthsSaved > 0)) {
                    savingsBox.classList.add('visible');
                    
                    document.getElementById('saveAmount').innerText = toCurrency(totalMoneySaved);
                    
                    // Format Time Saved
                    const yearsSaved = Math.floor(monthsSaved / 12);
                    const remMonths = monthsSaved % 12;
                    let timeString = "";
                    if(yearsSaved > 0) timeString += `${yearsSaved} Year${yearsSaved>1?'s':''} `;
                    if(remMonths > 0) timeString += `${remMonths} Month${remMonths>1?'s':''}`;
                    if(timeString === "") timeString = "0 Months";
                    document.getElementById('saveTime').innerText = timeString;

                } else {
                    savingsBox.classList.remove('visible');
                }

                if(hasPMI && pmiDropMonth > 0) {
                    const dropYear = Math.ceil(pmiDropMonth / 12);
                    let pmiText = `* Includes ${toCurrency(monthlyPMI)}/mo PMI until Month ${pmiDropMonth} (Year ${dropYear})`;
                    
                    // NEW: Compare PMI drop date vs Baseline
                    if(baselinePMIDropMonth > pmiDropMonth) {
                        const monthsEarlier = baselinePMIDropMonth - pmiDropMonth;
                        pmiText += ` â€” drops ${monthsEarlier} months earlier than standard!`;
                    }
                    
                    document.getElementById('pmiStatus').innerText = pmiText;
                } else if (!hasPMI) {
                     document.getElementById('pmiStatus').innerText = "No PMI required (Down payment â‰¥ 20%)";
                }

                // Update Result Text with Down Payment Amount
                let downText = "";
                if(downAmount > 0) {
                    downText = `(after down payment of <strong>${toCurrency(downAmount)}</strong>)`;
                } else {
                    downText = "(0% down payment)";
                }
                document.getElementById('downPaymentDisplayResult').innerHTML = downText;

                document.getElementById('displayTotalMonthly').innerText = toCurrency(initialTotalMonthly);
                document.getElementById('displayPI').innerText = toCurrency(monthlyPI);
                document.getElementById('displayTaxInsPMI').innerText = toCurrency(monthlyTax + monthlyIns + monthlyPMI + monthlyHOA);
                document.getElementById('displayLoanPrincipal').innerText = toCurrency(P);
                
                // UPDATE LIFETIME TOTALS UI
                document.getElementById('ltPrincipal').innerText = toCurrency(P);
                document.getElementById('ltInterest').innerText = toCurrency(newTotalInterest);
                document.getElementById('ltTax').innerText = toCurrency(totalLifetimeTax);
                document.getElementById('ltIns').innerText = toCurrency(totalLifetimeIns);
                
                // PMI Conditional
                if(totalLifetimePMI > 0) {
                    document.getElementById('ltPMIBox').style.display = 'flex';
                    document.getElementById('ltPMI').innerText = toCurrency(totalLifetimePMI);
                } else {
                    document.getElementById('ltPMIBox').style.display = 'none';
                }
                
                // HOA Conditional
                if(totalLifetimeHOA > 0) {
                    document.getElementById('ltHOABox').style.display = 'flex';
                    document.getElementById('ltHOA').innerText = toCurrency(totalLifetimeHOA);
                } else {
                    document.getElementById('ltHOABox').style.display = 'none';
                }
                
                // Total Sum
                const lifetimeGrandTotal = P + newTotalInterest + totalLifetimeTax + totalLifetimeIns + totalLifetimePMI + totalLifetimeHOA;
                document.getElementById('ltTotal').innerText = toCurrency(lifetimeGrandTotal);


                document.getElementById('placeholder').classList.add('hidden');
                document.getElementById('results').classList.remove('hidden');
                
                // FORCE SCROLL TO TOP OF RESULTS WITH OFFSET
                // Defensive check to avoid null error if element not found
                const resultsHeader = document.querySelector('.results-header'); 
                if (resultsHeader) {
                    const headerOffset = 120; // RESET TO 120px
                    const elementPosition = resultsHeader.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

                    window.scrollTo({
                        top: offsetPosition,
                        behavior: "smooth"
                    });
                }

                // Defensive check for Chart
                if (typeof Chart !== 'undefined') {
                    drawPieChart(monthlyPI, annualTax/12, annualIns/12, monthlyPMI, monthlyHOA);
                } else {
                    console.error("Chart.js library not loaded.");
                }
                
                // --- NEW: DYNAMIC BROWSER TITLE (SEO BOOST) ---
                document.title = `Plan: ${toCurrency(initialTotalMonthly).split('.')[0]}/mo | ${toCurrency(homePrice).split('.')[0]} Home`;

                setTimeout(() => { btn.innerText = origText; }, 300);

            } catch (error) {
                console.error(error);
                // Enhanced error message for debugging
                alert("An error occurred during calculation: " + error.message + "\n\nPlease check your inputs.");
                document.getElementById('calcBtn').innerText = "Plan Your Payment";
            }
        }

        function drawPieChart(pAndI, tax, ins, pmi, hoa) {
            const canvas = document.getElementById('myChart');
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            
            if(myChart) myChart.destroy();

            const labels = ['Principal & Interest', 'Property Tax', 'Home Insurance'];
            const data = [pAndI, tax, ins];
            const bgColors = ['#0f172a', '#0d9488', '#94a3b8'];

            if(pmi > 0) {
                labels.push('PMI');
                data.push(pmi);
                bgColors.push('#d97706'); 
            }
            if(hoa > 0) {
                labels.push('HOA Fees');
                data.push(hoa);
                bgColors.push('#8b5cf6'); 
            }

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: bgColors, 
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 20, font: { family: 'Inter', size: 12 } } },
                        tooltip: {
                            backgroundColor: '#0f172a',
                            titleFont: { family: 'Inter' },
                            bodyFont: { family: 'Inter' },
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed !== null) {
                                        label += toCurrency(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function exportPDF() {
            // STEP 1: Immediately open a blank window
            // This MUST be done on the initial click to bypass popup blockers
            const newWindow = window.open('', '_blank');
            
            // Safety check if the popup blocker still caught it
            if (!newWindow) {
               alert('Please allow popups for this site to view the PDF.');
               return;
            }

            // --- Updated Step 2: NO "Generating" text. Just prepare structure ---
            newWindow.document.write(`
                <html>
                    <head><title>Mortgage Plan PDF</title></head>
                    <body style="margin:0; background-color:#f8fafc;">
                    </body>
                </html>
            `);

            // STEP 3: Generate the PDF 
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // --- PDF GENERATION LOGIC ---
            const price = document.getElementById('homePrice').value;
            const downPmt = document.getElementById('downPayment').value;
            const downType = document.getElementById('downPaymentType').value === 'percent' ? '%' : '$';
            const rate = document.getElementById('interestRate').value;
            const term = document.getElementById('loanTerm').value;
            const tax = document.getElementById('annualTax').value;
            const ins = document.getElementById('annualIns').value;
            const hoa = document.getElementById('monthlyHOA').value;
            
            const extraPrincipal = document.getElementById('extraPrincipal').value;
            const incTax = document.getElementById('incTax').value;
            const incIns = document.getElementById('incIns').value;
            const incHoa = document.getElementById('incHOA').value;

            const monthly = document.getElementById('displayTotalMonthly').innerText.replace(/[^0-9.]/g, '');
            const principalVal = document.getElementById('displayLoanPrincipal').innerText;
            const cleanPrice = getCleanNumber('homePrice');

            const filename = `MortgagePlan_${Math.round(cleanPrice/1000)}k_${Math.round(monthly)}mo_${term}yr.pdf`;

            // ... PDF Content ...
            doc.setFont("helvetica", "bold");
            doc.setTextColor(15, 23, 42); 
            doc.setFontSize(22);
            doc.text("Mortgage Planner | Official Report", 14, 20);
            
            doc.setFontSize(11);
            doc.text("Loan Details:", 14, 32);
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            doc.setTextColor(50);
            
            let y = 40;
            doc.text(`Home Price: $${price}`, 14, y);
            doc.text(`Down Payment: ${downPmt}${downType}`, 14, y+6);
            doc.text(`Loan Amount: ${principalVal}`, 14, y+12);
            doc.text(`Interest Rate: ${rate}%`, 14, y+18);
            doc.text(`Loan Term: ${term} Years`, 14, y+24);

            doc.setFont("helvetica", "bold");
            doc.setTextColor(15, 23, 42); 
            doc.setFontSize(11);
            doc.text("Monthly Expenses:", 110, 32);
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            doc.setTextColor(50);
            
            let rightY = 40;
            doc.text(`Property Tax (Annual): $${tax}`, 110, rightY);
            doc.text(`Home Insurance (Annual): $${ins}`, 110, rightY+6);
            doc.text(`HOA Fees (Monthly): $${hoa || 0}`, 110, rightY+12);
            
            rightY += 18;
            
            if(currentSchedule.length > 0 && currentSchedule[0].pmi > 0) {
                 const pmiVal = currentSchedule[0].pmi;
                 const dropYear = Math.ceil(pmiDropMonth / 12);
                 doc.text(`PMI: ${toCurrency(pmiVal)} until Month ${pmiDropMonth} (Year ${dropYear})`, 110, rightY);
                 rightY += 6; 
            }

            const totalMonthlyText = document.getElementById('displayTotalMonthly').innerText;
            
            doc.setFont("helvetica", "bold");
            doc.setTextColor(13, 148, 136); 
            doc.text(`Initial Monthly Total: ${totalMonthlyText}`, 110, rightY + 4);
            
            y = 75; 
            doc.setDrawColor(200, 200, 200);
            doc.line(14, y-5, 196, y-5); 
            
            doc.setFont("helvetica", "bold");
            doc.setTextColor(15, 23, 42); 
            doc.text("Lifetime Cost Breakdown:", 14, y);
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(9);
            doc.setTextColor(50);
            y += 6;
            
            const ltPrincipal = document.getElementById('ltPrincipal').innerText;
            const ltInterest = document.getElementById('ltInterest').innerText;
            const ltTax = document.getElementById('ltTax').innerText;
            const ltIns = document.getElementById('ltIns').innerText;
            const ltTotal = document.getElementById('ltTotal').innerText;
            
            let summaryText = `Principal: ${ltPrincipal}    Interest: ${ltInterest}    Taxes: ${ltTax}    Insurance: ${ltIns}`;
            
            const pmiVal = document.getElementById('ltPMI').innerText;
            if(pmiVal !== "$0.00" && pmiVal !== "$0") summaryText += `    PMI: ${pmiVal}`;
            
            const hoaVal = document.getElementById('ltHOA').innerText;
            if(hoaVal !== "$0.00" && hoaVal !== "$0") summaryText += `    HOA: ${hoaVal}`;
            
            doc.text(summaryText, 14, y);
            
            y += 6;
            doc.setFont("helvetica", "bold");
            doc.setTextColor(13, 148, 136); 
            doc.text(`TOTAL LIFETIME COST: ${ltTotal}`, 14, y);

            y += 8; 
            
            if(typeof gtag === 'function') {
                gtag('event', 'click_save_pdf', {
                    'event_category': 'Engagement',
                    'event_label': 'PDF Export'
                });
            }
            
            if(getCleanNumber('extraPrincipal') > 0 || getCleanNumber('incTax') > 0 || getCleanNumber('incIns') > 0) {
                doc.setFont("helvetica", "bold");
                doc.setTextColor(15, 23, 42); 
                doc.setFontSize(10);
                doc.text("Assumed Increases & Extra Payments:", 14, y);
                
                doc.setFont("helvetica", "normal");
                doc.setTextColor(50);
                y += 5;
                
                let extraText = "";
                if(getCleanNumber('extraPrincipal') > 0) extraText += `Extra Principal: $${extraPrincipal}/mo.  `;
                if(getCleanNumber('incTax') > 0) extraText += `Tax Increase: ${incTax}%/yr.  `;
                if(getCleanNumber('incIns') > 0) extraText += `Ins Increase: ${incIns}%/yr.`;
                
                doc.text(extraText, 14, y);
                y += 6;
            }
            
            const tableData = currentSchedule.map(row => [
                row.year,
                row.num,
                toCurrency(row.int),
                toCurrency(row.prin),
                toCurrency(row.fees),
                toCurrency(row.total), 
                toCurrency(row.bal)
            ]);

            doc.autoTable({
                startY: y + 2, 
                head: [['Year', 'Month', 'Interest', 'Principal', 'Tax/Ins/Fees', 'Total', 'Balance']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [15, 23, 42] },
                styles: { font: 'helvetica', fontSize: 8 }, 
                didParseCell: function(data) {
                    if (data.row.raw[1] === pmiDropMonth) {
                        data.cell.styles.fillColor = [220, 252, 231]; 
                    }
                }
            });

            doc.setProperties({ title: filename });

            // STEP 4: USE DATA URI STRING (WIX FIX)
            // This bypasses the Blob restriction by embedding the entire file as a text string.
            const pdfDataUri = doc.output('datauristring');

            // Wait a split second to simulate loading, then replace content
            setTimeout(() => {
                newWindow.document.body.innerHTML = `
                    <iframe src="${pdfDataUri}" style="width:100%; height:100vh; border:none;"></iframe>
                `;
            }, 100);
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            initFromURL(); // Handle URL params if they exist
            updateDownPaymentHelper(); // Run this no matter what to catch defaults or URL updates
        });
    </script>
</body>
</html>
