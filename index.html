<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mortgage Payoff Planner | Calculator with Extra Payments & Tax Increases</title>
    <meta name="description" content="Calculate your mortgage amortization with extra payments, annual tax increases, and PMI removal. Plan your payoff strategy effectively.">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%230d9488%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6%22/></svg>">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        /* 1. RESET & VARIABLES */
        :root {
            --brand-navy: #0f172a;
            --brand-navy-light: #1e293b;
            --brand-teal: #0d9488;
            --brand-teal-dark: #0f766e;
            --brand-slate: #64748b;
            --brand-purple: #8b5cf6;
            --brand-red: #ef4444;
            
            --bg-body: #f1f5f9;
            --bg-white: #ffffff;
            --border-color: #cbd5e1;
        }

        /* GLOBAL BOX SIZING FIX */
        *, *::before, *::after { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }
        
        html, body {
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden; 
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--brand-navy);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            line-height: 1.5;
            padding-top: 72px; 
        }

        /* 2. NAVIGATION (FIXED & FULL WIDTH) */
        nav {
            background: var(--brand-navy);
            padding: 1rem 0;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            position: fixed; 
            top: 0;
            left: 0;
            z-index: 1000;
            width: 100%;
        }

        .nav-container {
            width: 100%; 
            padding: 0 2rem; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo { font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 10px; white-space: nowrap; }
        .logo svg { width: 22px; height: 22px; color: var(--brand-teal); flex-shrink: 0; }
        
        .nav-links a { text-decoration: none; color: #94a3b8; font-size: 0.9rem; font-weight: 500; transition: color 0.2s; cursor: pointer; white-space: nowrap; }
        .nav-links a:hover { color: white; }

        /* 3. HERO */
        .hero { background: white; padding: 2rem 1.5rem; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; text-align: center; width: 100%; }
        .hero h1 { font-size: 1.75rem; font-weight: 700; color: var(--brand-navy); margin-bottom: 0.25rem; }
        .hero p { color: var(--brand-slate); font-size: 1rem; max-width: 600px; margin: 0 auto; }

        /* 4. LAYOUT */
        .app-container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            flex: 1; 
            margin-bottom: 3rem;
            width: 100%;
            max-width: 100vw;
        }

        @media(min-width: 850px) {
            .app-container { grid-template-columns: 380px 1fr; }
        }

        /* --- MOBILE OPTIMIZATIONS --- */
        @media (max-width: 600px) {
            body { padding-top: 60px; }
            
            nav { padding: 0.75rem 0; }
            .nav-container { padding: 0 1rem; } 
            
            .hero { padding: 1.5rem 1rem; }
            .hero h1 { font-size: 1.5rem; }
            
            .app-container { padding: 0 12px; gap: 1.5rem; }
            
            .split-inputs { grid-template-columns: 1fr; gap: 0.75rem; }
            .three-col-mobile-fix { grid-template-columns: 1fr !important; }

            .summary-cards { 
                grid-template-columns: 1fr !important; 
                gap: 1rem !important; 
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .results-header button { width: 100%; }
        }

        /* CARD STYLES */
        .card {
            background: var(--bg-white);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            height: fit-content;
            width: 100%;
            max-width: 100%;
            overflow: hidden; 
        }

        @media (max-width: 600px) {
            .card { padding: 1.25rem; }
        }

        .card h2 {
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--brand-slate);
            margin-bottom: 1.5rem;
            font-weight: 700;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 10px;
        }

        /* --- INPUT STYLING --- */
        .input-group { margin-bottom: 1.25rem; width: 100%; }
        
        label {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.4rem;
            color: var(--brand-navy);
            gap: 6px;
        }

        .input-wrapper { position: relative; display: flex; align-items: center; width: 100%; }

        .input-icon {
            position: absolute;
            left: 12px;
            color: var(--brand-slate);
            font-weight: 500;
            font-size: 0.9rem;
            pointer-events: none; 
        }
        .input-icon.right { left: auto; right: 12px; }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            color: var(--brand-navy);
            transition: all 0.2s;
            background: #f8fafc;
            box-sizing: border-box;
        }

        input.has-left-icon { padding-left: 28px; }
        input.has-right-icon { padding-right: 28px; }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--brand-navy);
            background: white;
            box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.1);
        }

        .input-row { display: flex; gap: 10px; width: 100%; }
        .split-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; width: 100%; }

        /* TOOLTIPS */
        .tooltip-icon { cursor: help; color: var(--brand-slate); width: 14px; height: 14px; }
        .tooltip-container { position: relative; display: flex; align-items: center; }
        .tooltip-text {
            visibility: hidden; width: 200px; background-color: var(--brand-navy); color: #fff; text-align: center;
            border-radius: 6px; padding: 8px; position: absolute; z-index: 10; bottom: 125%; left: 50%;
            margin-left: -100px; opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; font-weight: 400;
            line-height: 1.4; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

        /* ADVANCED SECTION */
        .advanced-link { color: var(--brand-teal); font-size: 0.9rem; font-weight: 600; cursor: pointer; display: inline-block; margin-bottom: 0.5rem; user-select: none; }
        .advanced-link:hover { text-decoration: underline; color: var(--brand-teal-dark); }
        .advanced-content { margin-top: 0.5rem; padding-top: 1rem; border-top: 1px dashed var(--border-color); background: #f8fafc; padding: 1rem; border-radius: 6px; }
        .advanced-sub-header { font-size: 0.9rem; font-weight: 700; color: var(--brand-navy); margin-bottom: 0.75rem; margin-top: 0.5rem; }

        /* ONE TIME PAYMENT ROWS */
        .otp-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; width: 100%; }
        .otp-remove-btn { background: none; border: none; color: var(--brand-red); cursor: pointer; font-size: 1.1rem; padding: 0 5px; line-height: 1; }
        .otp-remove-btn:hover { opacity: 0.7; }
        .otp-add-btn { background: none; border: none; color: var(--brand-teal); font-size: 0.85rem; font-weight: 600; cursor: pointer; padding: 0; display: flex; align-items: center; gap: 4px; }
        .otp-add-btn:hover { text-decoration: underline; }

        /* BUTTONS */
        .btn-primary { width: 100%; padding: 1rem; background-color: var(--brand-navy); color: white; border: none; border-radius: 6px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: background 0.2s; margin-top: 1rem; }
        .btn-primary:hover { background-color: var(--brand-navy-light); }
        .btn-secondary { background: transparent; border: 1px solid var(--brand-navy); color: var(--brand-navy); padding: 0.5rem 1rem; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 0.85rem; }
        .btn-secondary:hover { background: #f1f5f9; }

        /* COFFEE BUTTON */
        .coffee-section { text-align: center; margin-bottom: 3rem; padding: 0 1rem; }
        .coffee-section p { font-size: 0.9rem; color: var(--brand-slate); margin-bottom: 0.75rem; font-weight: 500; }
        .btn-coffee { 
            display: inline-flex; align-items: center; gap: 8px;
            background-color: white; border: 1px solid var(--border-color); color: var(--brand-navy); 
            padding: 0.75rem 1.5rem; border-radius: 50px; font-weight: 600; text-decoration: none; 
            font-size: 0.9rem; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .btn-coffee:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-color: var(--brand-teal); color: var(--brand-teal-dark); }

        /* RESULTS UI */
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); }
        .results-header h2 { border: none; padding: 0; margin: 0; }
        
        .summary-cards { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 1rem; 
            margin-bottom: 2rem; 
            background: #f8fafc; 
            padding: 1rem; 
            border-radius: 8px; 
            border: 1px solid #e2e8f0; 
            width: 100%;
            box-sizing: border-box; 
        }

        @media (max-width: 600px) {
            .summary-cards { 
                grid-template-columns: 1fr !important; 
                gap: 1rem !important; 
            }
            .mini-card {
                display: flex;
                justify-content: space-between;
                align-items: center;
                text-align: left !important;
                padding: 0.5rem 0;
                border-bottom: 1px solid #e2e8f0;
            }
            .mini-card:last-child { border-bottom: none; }
            .mini-card small { margin-bottom: 0 !important; font-size: 0.8rem; }
            .mini-card strong { font-size: 1rem; }
        }
        
        .mini-card { text-align: center; background: transparent; }
        .mini-card small { display: block; color: var(--brand-slate); font-size: 0.75rem; margin-bottom: 4px; font-weight: 600; text-transform: uppercase; }
        .mini-card strong { display: block; color: var(--brand-navy); font-size: 1.1rem; font-weight: 700; }
        .mini-card .highlight { color: var(--brand-teal); font-size: 1.25rem; }
        
        .chart-container { 
            position: relative; 
            height: 260px; 
            margin-bottom: 2rem; 
            width: 100%; 
            max-width: 100%; 
            overflow: hidden; 
        }

        /* ACCORDION TABLE */
        .table-wrapper {
            max-height: 500px;
            overflow-y: auto;
            overflow-x: auto; 
            border: 1px solid var(--border-color);
            border-radius: 6px;
            width: 100%;
            max-width: 100%;
            display: block; 
        }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 400px; }
        
        thead th {
            background-color: #f1f5f9;
            color: var(--brand-navy);
            text-align: left;
            padding: 12px 16px;
            position: sticky;
            top: 0;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            z-index: 10;
            white-space: nowrap;
        }
        
        tbody td {
            padding: 10px 16px;
            border-bottom: 1px solid #f1f5f9;
            color: var(--brand-slate);
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
        }

        @media (max-width: 600px) {
            .table-wrapper { border-radius: 4px; }
            table { font-size: 0.75rem; }
            th, td { padding: 8px 10px; }
            td:first-child, th:first-child { white-space: nowrap; min-width: 80px; }
        }

        .year-row { background-color: #f8fafc; cursor: pointer; font-weight: 600; border-bottom: 1px solid #e2e8f0; }
        .year-row:hover { background-color: #f1f5f9; }
        .year-row td { color: var(--brand-navy); }
        .month-row { display: none; background-color: white; }
        .month-row.active { display: table-row; }
        .month-row td { padding-left: 24px; font-size: 0.8rem; }
        .toggle-icon { display: inline-block; width: 16px; text-align: center; transition: transform 0.2s; margin-right: 6px; }
        .year-row.expanded .toggle-icon { transform: rotate(90deg); }
        .pmi-drop-row { background-color: #dcfce7 !important; }
        .one-time-row { background-color: #e0e7ff !important; }

        /* MODAL STYLES */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.5); z-index: 1000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        
        .modal-content {
            background: white; width: 90%; max-width: 500px;
            padding: 2rem; border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transform: translateY(20px); transition: transform 0.2s;
            max-height: 80vh; overflow-y: auto; /* Allow scrolling for long policies */
        }
        .modal-overlay.open .modal-content { transform: translateY(0); }
        .modal-header { font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 1.5rem; }
        .btn-cancel { background: transparent; border: 1px solid var(--border-color); color: var(--brand-slate); padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .btn-cancel:hover { background: #f1f5f9; }

        /* POLICY TEXT STYLES */
        .policy-text h3 { font-size: 1rem; margin-top: 1rem; margin-bottom: 0.5rem; color: var(--brand-navy); }
        .policy-text p { font-size: 0.9rem; color: #475569; margin-bottom: 0.8rem; line-height: 1.6; }
        .policy-text ul { margin-left: 1.5rem; margin-bottom: 1rem; font-size: 0.9rem; color: #475569; }

        /* CONTENT ACCORDIONS */
        .content-section {
            max-width: 1100px;
            margin: 0 auto 3rem auto;
            padding: 0 1.5rem;
        }
        .content-card {
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            margin-bottom: 1rem;
        }
        .content-header {
            padding: 1.5rem;
            font-weight: 700;
            color: var(--brand-navy);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
            border-bottom: 1px solid transparent;
            transition: all 0.2s;
        }
        .content-header:hover { background: #f1f5f9; }
        .content-header.active { border-bottom: 1px solid var(--border-color); color: var(--brand-teal-dark); }
        
        .content-body {
            display: none;
            padding: 1.5rem;
            color: var(--brand-navy-light);
            line-height: 1.7;
            font-size: 0.95rem;
        }
        .content-body h3 { font-size: 1.1rem; margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--brand-navy); }
        .content-body h3:first-child { margin-top: 0; }
        .content-body p { margin-bottom: 1rem; color: #475569; }
        .content-body ul { margin-left: 1.5rem; margin-bottom: 1rem; color: #475569; }
        .content-body li { margin-bottom: 0.5rem; }

        /* Animations */
        @keyframes pulse-card {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(0.99); background-color: #f8fafc; }
            100% { opacity: 1; transform: scale(1); background-color: white; }
        }
        .pulse-animation { animation: pulse-card 0.3s ease-out; }

        .hidden { display: none !important; }
        .placeholder-state { text-align: center; color: var(--brand-slate); padding: 4rem 1rem; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; }

        footer { margin-top: auto; background: var(--brand-navy); color: #94a3b8; padding: 3rem 1.5rem; text-align: center; font-size: 0.85rem; width: 100%; }
        .footer-links { margin-top: 1rem; display: flex; justify-content: center; gap: 1.5rem; }
        .footer-links a { color: #94a3b8; text-decoration: none; transition: color 0.2s; cursor: pointer; }
        .footer-links a:hover { color: white; text-decoration: underline; }
        .disclaimer { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.75rem; color: #64748b; max-width: 800px; margin-left: auto; margin-right: auto; line-height: 1.6; }
    </style>
</head>
<body>

    <nav>
        <div class="nav-container">
            <div class="logo">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                Mortgage Planner
            </div>
            <div class="nav-links">
                <a href="#" onclick="openFeedback()">Feedback</a>
            </div>
        </div>
    </nav>

    <div id="feedbackModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">Send Feedback</div>
            
            <form action="https://formsubmit.co/jflazor@gmail.com" method="POST">
                <div class="input-group">
                    <label>Feedback Type</label>
                    <select name="type">
                        <option value="Feature Enhancement">Feature Enhancement Request</option>
                        <option value="Technical Issue">Technical Issue</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Name <span style="font-weight: 400; color: #94a3b8;">(Optional)</span></label>
                    <input type="text" name="name" placeholder="John Doe">
                </div>
                <div class="input-group">
                    <label>Email Address <span style="font-weight: 400; color: #94a3b8;">(Optional)</span></label>
                    <input type="email" name="email" placeholder="you@example.com">
                </div>
                <div class="input-group">
                    <label>Message</label>
                    <textarea name="message" rows="4" placeholder="Tell us what you think..." required style="resize: vertical;"></textarea>
                </div>
                <input type="hidden" name="_subject" value="Mortgage Planner Feedback">
                <input type="hidden" name="_captcha" value="false"> 
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeFeedback()">Cancel</button>
                    <button type="submit" class="btn-primary" style="width: auto; margin:0;">Submit Feedback</button>
                </div>
            </form>
        </div>
    </div>

    <div id="privacyModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">Privacy Policy</div>
            <div class="policy-text">
                <p><strong>Last Updated: January 2025</strong></p>
                <p>Your privacy is important to us. It is Mortgage Planner's policy to respect your privacy regarding any information we may collect from you across our website.</p>
                
                <h3>1. Information Collection</h3>
                <p>We do not ask for personal information (such as your name, email, or phone number) unless we truly need it to provide a service (like our Feedback form). We do not store financial data entered into the calculator on our servers; all calculations happen locally in your browser.</p>
                
                <h3>2. Cookies and Third-Party Services</h3>
                <p>We use third-party services, such as Google Analytics and Google AdSense, to improve our service and display advertisements. These third parties may use cookies, web beacons, and other storage technologies to collect or receive information from your website and elsewhere on the internet and use that information to provide measurement services and target ads.</p>
                <ul>
                    <li><strong>Google AdSense:</strong> Third-party vendors, including Google, use cookies to serve ads based on a user's prior visits to your website or other websites. Google's use of advertising cookies enables it and its partners to serve ads to your users based on their visit to your sites and/or other sites on the Internet.</li>
                </ul>
                
                <h3>3. Opting Out</h3>
                <p>Users may opt out of personalized advertising by visiting <a href="https://www.google.com/settings/ads" target="_blank" style="color:#0d9488;">Google Ad Settings</a>. Alternatively, you can opt out of a third-party vendor's use of cookies for personalized advertising by visiting <a href="http://www.aboutads.info/choices/" target="_blank" style="color:#0d9488;">www.aboutads.info</a>.</p>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-primary" style="width: auto;" onclick="closeModal('privacyModal')">Close</button>
            </div>
        </div>
    </div>

    <div id="termsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">Terms of Service & Disclaimer</div>
            <div class="policy-text">
                <p><strong>Last Updated: January 2025</strong></p>
                
                <h3>1. Educational Purpose Only</h3>
                <p>The Mortgage Planner tool is designed for educational and informational purposes only. It is intended to provide estimates based on the information you provide. It is not a financial institution, lender, or financial advisor.</p>
                
                <h3>2. No Financial Advice</h3>
                <p>The results provided by this calculator should not be construed as financial, legal, or tax advice. You should consult with a qualified professional (such as a loan officer, accountant, or financial advisor) before making any financial decisions.</p>
                
                <h3>3. Accuracy of Information</h3>
                <p>While we strive to keep the calculator accurate, we cannot guarantee the accuracy, completeness, or reliability of any results. Actual loan terms, interest rates, and payments may vary depending on your lender and individual financial situation. We are not responsible for any errors or omissions, or for the results obtained from the use of this information.</p>
                
                <h3>4. Limitation of Liability</h3>
                <p>In no event shall Mortgage Planner be liable for any direct, indirect, incidental, or consequential damages arising out of the use of or inability to use this website or its tools.</p>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-primary" style="width: auto;" onclick="closeModal('termsModal')">Close</button>
            </div>
        </div>
    </div>

    <div class="hero">
        <h1>See Your Future Payments</h1>
        <p>Preview your full mortgage breakdown, taxes, and amortization schedule instantly.</p>
    </div>

    <div class="app-container">
        
        <div class="card">
            <h2>Loan Parameters</h2>
            
            <div class="input-group">
                <label>Home Price ($)</label>
                <div class="input-wrapper">
                    <span class="input-icon">$</span>
                    <input type="text" id="homePrice" class="has-left-icon" value="350,000" placeholder="350,000" onblur="formatInput(this)">
                </div>
            </div>

            <div class="input-group">
                <label>Down Payment</label>
                <div class="input-row">
                    <div class="input-wrapper" style="flex:1;">
                        <span class="input-icon right" id="downIcon">%</span>
                        <input type="text" id="downPayment" class="has-right-icon" value="20" onblur="formatInput(this)">
                    </div>
                    <select id="downPaymentType" style="width: 70px; text-align:center; font-weight:600;" onchange="updateDownIcon()">
                        <option value="percent">%</option>
                        <option value="dollar">$</option>
                    </select>
                </div>
            </div>

            <div class="split-inputs">
                <div class="input-group">
                    <label>Interest Rate</label>
                    <div class="input-wrapper">
                        <input type="number" id="interestRate" class="has-right-icon" value="6.5" step="0.1">
                        <span class="input-icon right">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <label>Term (Years)</label>
                    <input type="number" id="loanTerm" value="30">
                </div>
            </div>

            <div class="split-inputs">
                <div class="input-group">
                    <label>Prop. Tax ($/Yr)</label>
                    <div class="input-wrapper">
                        <span class="input-icon">$</span>
                        <input type="text" id="annualTax" class="has-left-icon" value="3,000" placeholder="0" onblur="formatInput(this)">
                    </div>
                </div>
                <div class="input-group">
                    <label>Insurance ($/Yr)</label>
                    <div class="input-wrapper">
                        <span class="input-icon">$</span>
                        <input type="text" id="annualIns" class="has-left-icon" value="1,200" placeholder="0" onblur="formatInput(this)">
                    </div>
                </div>
            </div>
            
            <div class="split-inputs">
                <div class="input-group">
                    <label>
                        Annual PMI Rate
                        <div class="tooltip-container">
                            <svg class="tooltip-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <span class="tooltip-text">Private Mortgage Insurance is usually required if down payment is under 20%.</span>
                        </div>
                    </label>
                    <div class="input-wrapper">
                        <input type="number" id="pmiRate" class="has-right-icon" value="0.5" step="0.1">
                        <span class="input-icon right">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <label>
                        Monthly HOA
                        <div class="tooltip-container">
                            <svg class="tooltip-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <span class="tooltip-text">Homeowners Association fees are separate from your mortgage but impact affordability.</span>
                        </div>
                    </label>
                    <div class="input-wrapper">
                        <span class="input-icon">$</span>
                        <input type="text" id="monthlyHOA" class="has-left-icon" value="" placeholder="0" onblur="formatInput(this)">
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <span id="advancedToggle" class="advanced-link" onclick="toggleAdvanced()">(+) Advanced Options</span>
                <div id="advancedSection" class="advanced-content hidden">
                    
                    <div class="advanced-sub-header" style="margin-top: 0;">Annual Increases</div>
                    <div class="split-inputs three-col-mobile-fix" style="grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin-bottom: 1.5rem;">
                        <div class="input-group" style="margin-bottom:0;">
                            <label style="font-size: 0.75rem;">Tax %</label>
                            <input type="number" id="incTax" value="0" step="0.1">
                        </div>
                        <div class="input-group" style="margin-bottom:0;">
                            <label style="font-size: 0.75rem;">Ins. %</label>
                            <input type="number" id="incIns" value="0" step="0.1">
                        </div>
                        <div class="input-group" style="margin-bottom:0;">
                            <label style="font-size: 0.75rem;">HOA %</label>
                            <input type="number" id="incHOA" value="0" step="0.1">
                        </div>
                    </div>

                    <div class="input-group">
                        <label>
                            Extra Monthly Principal
                            <div class="tooltip-container">
                                <svg class="tooltip-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                <span class="tooltip-text">Added directly to your loan balance every month to pay it off faster.</span>
                            </div>
                        </label>
                        <div class="input-wrapper">
                            <span class="input-icon">$</span>
                            <input type="text" id="extraPrincipal" class="has-left-icon" value="" placeholder="0" onblur="formatInput(this)">
                        </div>
                    </div>

                    <div class="advanced-sub-header" style="margin-top: 1.5rem;">Extra One-Time Payments</div>
                    <div id="oneTimeContainer">
                        <div class="otp-row">
                            <input type="number" placeholder="Month #" class="otp-month" style="width: 40%;" min="1">
                            <div class="input-wrapper" style="flex: 1;">
                                <span class="input-icon">$</span>
                                <input type="text" placeholder="Amount" class="has-left-icon otp-amount" onblur="formatInput(this)">
                            </div>
                            <button class="otp-remove-btn" onclick="removeOneTimeRow(this)" title="Remove">×</button>
                        </div>
                    </div>
                    <button class="otp-add-btn" onclick="addOneTimeRow()">
                        <span style="font-size: 1.2rem; font-weight:bold;">+</span> Add another payment
                    </button>

                </div>
            </div>

            <button id="calcBtn" class="btn-primary" onclick="calculate()">Plan Your Payment</button>
        </div>

        <div class="card">
            <div id="placeholder" class="placeholder-state">
                <svg style="width: 56px; height: 56px; margin-bottom: 1rem; color: #cbd5e1;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                <p>Enter your details on the left to<br>generate your Mortgage Plan.</p>
            </div>

            <div id="results" class="hidden">
                <div class="results-header">
                    <h2>Your Plan Breakdown</h2>
                    <button class="btn-secondary" onclick="exportPDF()">Save PDF</button>
                </div>

                <div class="summary-cards">
                    <div class="mini-card">
                        <small>Initial Monthly Payment</small>
                        <strong class="highlight" id="displayTotalMonthly">$0</strong>
                    </div>
                    <div class="mini-card">
                        <small>Principal & Interest</small>
                        <strong id="displayPI">$0</strong>
                    </div>
                    <div class="mini-card">
                        <small>Taxes, Insurance, & Other Fees</small>
                        <strong id="displayTaxInsPMI">$0</strong>
                    </div>
                </div>

                <p style="text-align: center; font-size: 0.85rem; color: #64748b; margin-bottom: 1.5rem;">
                    Loan Principal: <strong id="displayLoanPrincipal">$0</strong> (after down payment)
                    <br><span id="pmiStatus" style="font-size:0.8rem; color:#d97706;"></span>
                </p>

                <div class="chart-container">
                    <canvas id="myChart"></canvas>
                </div>

                <h2 style="font-size: 0.9rem; margin-bottom: 1rem; border-bottom: none;">Amortization Schedule (Click Years to Expand)</h2>
                <div class="table-wrapper">
                    <table id="amortizationTable">
                        <thead>
                            <tr>
                                <th>Year / Month</th>
                                <th>Interest</th>
                                <th>Principal</th>
                                <th>Total Pmt</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="content-section">
        <h2 style="font-size: 1.25rem; margin-bottom: 1rem; text-align: center; color: var(--brand-navy);">Mortgage Guide & FAQs</h2>
        
        <div class="content-card">
            <div class="content-header" onclick="toggleContent(this)">
                <span>How to Use This Mortgage Planner</span>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="content-body">
                <h3>Step-by-Step Instructions</h3>
                <p>1. <strong>Enter Loan Details:</strong> Input your home price, down payment, interest rate, and loan term in the "Loan Parameters" section.</p>
                <p>2. <strong>Add Expenses:</strong> Fill in your estimated annual property tax and insurance. If you have an HOA fee, include that as a monthly cost.</p>
                <p>3. <strong>Check Advanced Options:</strong> Click the "Advanced Options" link to account for annual tax increases or to simulate making extra payments to pay off your loan faster.</p>
                <p>4. <strong>Analyze Results:</strong> Click "Plan Your Payment" to generate a full visualization. Use the interactive amortization table to see exactly when PMI drops off or when you will be debt-free.</p>
            </div>
        </div>

        <div class="content-card">
            <div class="content-header" onclick="toggleContent(this)">
                <span>Strategies to Save Thousands in Interest</span>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="content-body">
                <h3>The Power of Extra Payments</h3>
                <p>One of the most effective ways to save money is by making extra principal payments. Because interest is calculated on your remaining balance, every dollar you pay down early reduces the interest charged for every single month thereafter.</p>
                <ul>
                    <li><strong>Round Up:</strong> Rounding your payment up to the nearest $100 can shave years off your loan.</li>
                    <li><strong>The "13th Payment":</strong> Making one extra full payment per year can reduce a 30-year mortgage to roughly 22-23 years.</li>
                    <li><strong>Recasting:</strong> If you come into a lump sum (like a bonus), apply it as a "One-Time Payment" in this calculator to see how it impacts your timeline.</li>
                </ul>
            </div>
        </div>

        <div class="content-card">
            <div class="content-header" onclick="toggleContent(this)">
                <span>Frequently Asked Questions</span>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="content-body">
                <h3>What is PMI and when does it go away?</h3>
                <p>PMI (Private Mortgage Insurance) is usually required if you put down less than 20%. It protects the lender, not you. This calculator automatically estimates when your balance reaches 78-80% of the home value, which is when PMI typically drops off.</p>
                
                <h3>How do Property Tax increases affect me?</h3>
                <p>Unlike a fixed-rate mortgage payment, taxes and insurance rise over time. Use the "Annual Increases" section in Advanced Options to see how a 2-3% annual tax hike could change your monthly payment in 10 or 20 years.</p>
                
                <h3>Should I pay off my mortgage or invest?</h3>
                <p>This depends on your interest rate versus expected investment returns. If your mortgage rate is 7% and the market returns 5%, paying off the debt is a guaranteed 7% return. Use this tool to see exactly how much interest you save by paying early.</p>
            </div>
        </div>
    </div>

    <div class="coffee-section">
        <p>Found this tool helpful?</p>
        <a href="https://buymeacoffee.com/mortgageplanner" target="_blank" class="btn-coffee">
            ☕ Buy me a coffee
        </a>
    </div>

    <footer>
        <p>© <span id="copyrightYear">2024</span> Mortgage Planner. All rights reserved.</p>
        <div class="footer-links">
            <a onclick="openModal('privacyModal')">Privacy Policy</a>
            <a onclick="openModal('termsModal')">Terms of Service</a>
        </div>
        <div class="disclaimer">
            <p><strong>Disclaimer:</strong> This tool is provided for visualization and planning purposes only. It calculates estimates based on the inputs provided. Future tax, insurance, and HOA increases are projections and may vary. Please contact a qualified loan officer or financial institution for official loan estimates.</p>
        </div>
    </footer>

    <script>
        // SET DYNAMIC YEAR
        document.getElementById('copyrightYear').innerText = new Date().getFullYear();

        // --- GENERIC MODAL FUNCTIONS ---
        function openModal(id) {
            document.getElementById(id).classList.add('open');
        }
        function closeModal(id) {
            document.getElementById(id).classList.remove('open');
        }

        // WRAPPERS FOR SPECIFIC BUTTONS
        function openFeedback() { openModal('feedbackModal'); }
        function closeFeedback() { closeModal('feedbackModal'); }

        // --- CONTENT ACCORDION TOGGLE ---
        function toggleContent(header) {
            const body = header.nextElementSibling;
            const icon = header.querySelector('.toggle-icon');
            
            if (body.style.display === "block") {
                body.style.display = "none";
                header.classList.remove('active');
                icon.style.transform = "rotate(0deg)";
            } else {
                body.style.display = "block";
                header.classList.add('active');
                icon.style.transform = "rotate(180deg)";
            }
        }

        let currentSchedule = [];
        let myChart = null;
        let pmiDropMonth = 0; 

        // 1. HELPERS
        function cleanString(str) {
            if(!str) return 0;
            const cleaned = String(str).replace(/[^0-9.]/g, '');
            const parsed = parseFloat(cleaned);
            return isNaN(parsed) ? 0 : parsed;
        }

        function toCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function getCleanNumber(id) {
            const el = document.getElementById(id);
            if (!el) return 0;
            return cleanString(el.value);
        }

        function formatInput(input) {
            let val = input.value.replace(/[^0-9.]/g, ''); 
            if(val) {
                let number = parseFloat(val);
                input.value = number.toLocaleString('en-US'); 
            }
        }

        // 2. UI INTERACTIONS
        function toggleAdvanced() {
            const section = document.getElementById('advancedSection');
            const toggleBtn = document.getElementById('advancedToggle');
            section.classList.toggle('hidden');
            toggleBtn.innerText = section.classList.contains('hidden') ? "(+) Advanced Options" : "(-) Advanced Options";
        }

        function updateDownIcon() {
            const type = document.getElementById('downPaymentType').value;
            const icon = document.getElementById('downIcon');
            const input = document.getElementById('downPayment');

            if (type === 'percent') {
                icon.innerText = '%';
                icon.classList.add('right');
                input.classList.remove('has-left-icon');
                input.classList.add('has-right-icon');
            } else {
                icon.innerText = '$';
                icon.classList.remove('right');
                input.classList.remove('has-right-icon');
                input.classList.add('has-left-icon');
            }
        }

        function addOneTimeRow() {
            const container = document.getElementById('oneTimeContainer');
            const div = document.createElement('div');
            div.className = 'otp-row';
            div.innerHTML = `
                <input type="number" placeholder="Month #" class="otp-month" style="width: 40%;" min="1">
                <div class="input-wrapper" style="flex: 1;">
                    <span class="input-icon">$</span>
                    <input type="text" placeholder="Amount" class="has-left-icon otp-amount" onblur="formatInput(this)">
                </div>
                <button class="otp-remove-btn" onclick="removeOneTimeRow(this)" title="Remove">×</button>
            `;
            container.appendChild(div);
        }

        function removeOneTimeRow(btn) {
            const row = btn.parentElement;
            row.remove();
        }

        function toggleYear(year) {
            const rows = document.querySelectorAll(`.year-${year}`);
            const yearRow = document.getElementById(`year-header-${year}`);
            
            let isExpanding = false;
            rows.forEach(row => {
                if(row.classList.contains('active')) {
                    row.classList.remove('active');
                } else {
                    row.classList.add('active');
                    isExpanding = true;
                }
            });

            if(isExpanding) yearRow.classList.add('expanded');
            else yearRow.classList.remove('expanded');
        }

        // --- MAIN CALCULATION ---
        function calculate() {
            try {
                // UI: Button Effect
                const btn = document.getElementById('calcBtn');
                const origText = btn.innerText;
                btn.innerText = "Updating...";
                
                // UI: Pulse Effect
                const resultsDiv = document.getElementById('results');
                resultsDiv.classList.remove('pulse-animation');
                void resultsDiv.offsetWidth; 
                resultsDiv.classList.add('pulse-animation');

                // INPUTS
                const homePrice = getCleanNumber('homePrice');
                const annualTax = getCleanNumber('annualTax');
                const annualIns = getCleanNumber('annualIns');
                const monthlyHOA = getCleanNumber('monthlyHOA'); 
                const extraPrincipal = getCleanNumber('extraPrincipal'); 

                const monthlyTax = annualTax / 12;
                const monthlyIns = annualIns / 12;

                const incTaxRate = parseFloat(document.getElementById('incTax').value) || 0;
                const incInsRate = parseFloat(document.getElementById('incIns').value) || 0;
                const incHOARate = parseFloat(document.getElementById('incHOA').value) || 0;

                const rRaw = parseFloat(document.getElementById('interestRate').value) || 0;
                const r = rRaw / 100 / 12;
                const nRaw = parseFloat(document.getElementById('loanTerm').value) || 0;
                const n = nRaw * 12;
                
                const pmiRateAnnual = parseFloat(document.getElementById('pmiRate').value) || 0;
                const pmiRateMonthly = pmiRateAnnual / 100;

                // Down Payment
                const downVal = getCleanNumber('downPayment');
                const downType = document.getElementById('downPaymentType').value;
                let downAmount = 0;
                if(downType === 'percent') {
                    downAmount = homePrice * (downVal / 100);
                } else {
                    downAmount = downVal;
                }

                const P = homePrice - downAmount;

                // Validations
                if(!homePrice || !n) {
                    alert("Please fill in Home Price and Loan Term.");
                    btn.innerText = origText;
                    return;
                }
                if(P <= 0) {
                    alert("Down payment cannot be larger than home price.");
                    btn.innerText = origText;
                    return;
                }

                // OTP Logic
                const otpMap = {}; 
                const otpRows = document.querySelectorAll('.otp-row');
                otpRows.forEach(row => {
                    const monthInput = row.querySelector('.otp-month');
                    const amtInput = row.querySelector('.otp-amount');
                    if(monthInput && amtInput) {
                        const m = parseInt(monthInput.value);
                        const amt = cleanString(amtInput.value);
                        if(!isNaN(m) && m > 0 && amt > 0) {
                            if(otpMap[m]) otpMap[m] += amt;
                            else otpMap[m] = amt;
                        }
                    }
                });

                // PMI
                let monthlyPMI = 0;
                const ltv = (P / homePrice); 
                const hasPMI = ltv > 0.80; 
                pmiDropMonth = 0;
                
                if(hasPMI) {
                    monthlyPMI = (P * pmiRateMonthly) / 12;
                    document.getElementById('pmiStatus').innerText = "* Includes PMI (See schedule for removal date)";
                } else {
                    document.getElementById('pmiStatus').innerText = "No PMI required (Down payment ≥ 20%)";
                }

                // P&I
                let monthlyPI = 0;
                if (r === 0) {
                    monthlyPI = P / n;
                } else {
                    monthlyPI = P * (r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
                }
                
                let currentMonthlyTax = annualTax / 12;
                let currentMonthlyIns = annualIns / 12;
                let currentMonthlyHOA = monthlyHOA;

                const initialTotalMonthly = monthlyPI + currentMonthlyTax + currentMonthlyIns + monthlyPMI + currentMonthlyHOA;

                // --- GENERATE SCHEDULE (ACCORDION LOGIC) ---
                let balance = P;
                currentSchedule = [];
                const previewBody = document.getElementById('previewTableBody');
                let tableHTML = "";
                
                // Track Yearly Totals
                let yearlyInt = 0, yearlyPrin = 0, yearlyTotal = 0;
                let monthBuffer = [];

                for(let i=1; i<=n; i++) {
                    const currentYear = Math.ceil(i/12);

                    // Increases
                    if (i > 1 && (i - 1) % 12 === 0) {
                        currentMonthlyTax *= (1 + (incTaxRate / 100));
                        currentMonthlyIns *= (1 + (incInsRate / 100));
                        currentMonthlyHOA *= (1 + (incHOARate / 100));
                    }

                    let interest = balance * r;
                    let principal = monthlyPI - interest;
                    
                    let oneTimePayment = otpMap[i] || 0; 
                    let totalPrincipalPayment = principal + extraPrincipal + oneTimePayment;
                    
                    if(totalPrincipalPayment > balance) totalPrincipalPayment = balance;

                    balance -= totalPrincipalPayment;
                    if(balance < 0) balance = 0;

                    // PMI Removal
                    let currentPMI = 0;
                    let rowClass = "month-row year-" + currentYear;
                    
                    if(oneTimePayment > 0) rowClass += " one-time-row";

                    if(hasPMI) {
                        if(balance > (homePrice * 0.8)) {
                            currentPMI = monthlyPMI;
                        } else if(pmiDropMonth === 0) {
                            currentPMI = 0;
                            pmiDropMonth = i; 
                            rowClass += " pmi-drop-row"; 
                        } else {
                            currentPMI = 0;
                        }
                    }

                    const monthTotalPay = interest + totalPrincipalPayment + currentMonthlyTax + currentMonthlyIns + currentMonthlyHOA + currentPMI;

                    // Add to Totals
                    yearlyInt += interest;
                    yearlyPrin += totalPrincipalPayment;
                    yearlyTotal += monthTotalPay;

                    const rowData = {
                        num: i,
                        year: currentYear,
                        int: interest,
                        prin: totalPrincipalPayment,
                        bal: balance,
                        total: monthTotalPay,
                        pmi: currentPMI
                    };
                    currentSchedule.push(rowData);

                    // Buffer Month Row HTML
                    monthBuffer.push(`
                        <tr class="${rowClass}">
                            <td>Month ${i} ${rowData.pmi===0 && pmiDropMonth===i ? '(PMI Removed)' : ''}</td>
                            <td>${toCurrency(interest)}</td>
                            <td>${toCurrency(totalPrincipalPayment)}</td>
                            <td>${toCurrency(monthTotalPay)}</td>
                            <td>${toCurrency(balance)}</td>
                        </tr>
                    `);

                    // END OF YEAR or PAID OFF: Render Group
                    if(i % 12 === 0 || balance <= 0.01) {
                        const yearId = `year-header-${currentYear}`;
                        tableHTML += `
                            <tr class="year-row" id="${yearId}" onclick="toggleYear(${currentYear})">
                                <td><span class="toggle-icon">▶</span> Year ${currentYear} Summary</td>
                                <td>${toCurrency(yearlyInt)}</td>
                                <td>${toCurrency(yearlyPrin)}</td>
                                <td>${toCurrency(yearlyTotal)}</td>
                                <td>${toCurrency(balance)}</td>
                            </tr>
                        `;
                        tableHTML += monthBuffer.join('');
                        
                        // Reset for next year
                        monthBuffer = [];
                        yearlyInt = 0; yearlyPrin = 0; yearlyTotal = 0;
                    }

                    if(balance <= 0.01) break;
                }

                previewBody.innerHTML = tableHTML;

                if(hasPMI && pmiDropMonth > 0) {
                    const dropYear = Math.ceil(pmiDropMonth / 12);
                    document.getElementById('pmiStatus').innerText = `* Includes PMI until Month ${pmiDropMonth} (Year ${dropYear})`;
                }

                document.getElementById('displayTotalMonthly').innerText = toCurrency(initialTotalMonthly);
                document.getElementById('displayPI').innerText = toCurrency(monthlyPI);
                document.getElementById('displayTaxInsPMI').innerText = toCurrency(monthlyTax + monthlyIns + monthlyPMI + monthlyHOA);
                document.getElementById('displayLoanPrincipal').innerText = toCurrency(P);

                document.getElementById('placeholder').classList.add('hidden');
                document.getElementById('results').classList.remove('hidden');
                
                // AUTO SCROLL
                resultsDiv.scrollIntoView({ behavior: 'smooth' });

                drawPieChart(monthlyPI, annualTax/12, annualIns/12, monthlyPMI, monthlyHOA);
                
                setTimeout(() => { btn.innerText = origText; }, 300);

            } catch (error) {
                console.error(error);
                alert("An error occurred during calculation. Please check your inputs.");
                document.getElementById('calcBtn').innerText = "Plan Your Payment";
            }
        }

        function drawPieChart(pAndI, tax, ins, pmi, hoa) {
            const canvas = document.getElementById('myChart');
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            
            if(myChart) myChart.destroy();

            const labels = ['Principal & Interest', 'Property Tax', 'Home Insurance'];
            const data = [pAndI, tax, ins];
            const bgColors = ['#0f172a', '#0d9488', '#94a3b8'];

            if(pmi > 0) {
                labels.push('PMI');
                data.push(pmi);
                bgColors.push('#d97706'); 
            }
            if(hoa > 0) {
                labels.push('HOA Fees');
                data.push(hoa);
                bgColors.push('#8b5cf6'); 
            }

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: bgColors, 
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 20, font: { family: 'Inter', size: 12 } } },
                        tooltip: {
                            backgroundColor: '#0f172a',
                            titleFont: { family: 'Inter' },
                            bodyFont: { family: 'Inter' },
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed !== null) {
                                        label += toCurrency(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFont("helvetica", "bold");
            doc.setTextColor(15, 23, 42); 
            doc.setFontSize(22);
            doc.text("Mortgage Planner | Official Report", 14, 22);
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            doc.setTextColor(100);
            const totalMonthly = document.getElementById('displayTotalMonthly').innerText;
            doc.text(`Initial Monthly Payment: ${totalMonthly}`, 14, 30);
            
            const principal = document.getElementById('displayLoanPrincipal').innerText;
            doc.text(`Total Loan Amount Financed: ${principal}`, 14, 36);
            
            const pmiText = document.getElementById('pmiStatus').innerText;
            doc.setTextColor(217, 119, 6); 
            doc.text(pmiText, 14, 42);

            if(pmiDropMonth > 0) {
                doc.setTextColor(34, 197, 94); 
                doc.text(`PMI Estimated Removal: Payment #${pmiDropMonth}`, 14, 48);
            }

            const tableData = currentSchedule.map(row => [
                row.year,
                row.num,
                toCurrency(row.int),
                toCurrency(row.prin),
                toCurrency(row.total), 
                toCurrency(row.bal)
            ]);

            doc.autoTable({
                startY: 55,
                head: [['Year', 'Month', 'Interest', 'Principal', 'Total Payment', 'Balance']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [15, 23, 42] },
                styles: { font: 'helvetica', fontSize: 8 }, 
                didParseCell: function(data) {
                    if (data.row.raw[1] === pmiDropMonth) {
                        data.cell.styles.fillColor = [220, 252, 231]; 
                    }
                }
            });

            doc.save('MortgagePlanner-Report.pdf');
        }
    </script>
</body>
</html>
